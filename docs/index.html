<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plaincast - NWS Forecasts, Decoded into Plain English</title>
    <meta name="description" content="Area Forecast Discussions decoded into plain English. Side-by-side translation of NWS meteorologist forecasts with 150+ term jargon glossary, confidence indicators, and smart abbreviation expansion. 19 offices.">
    <meta name="keywords" content="NWS, weather forecast, Area Forecast Discussion, AFD, plain English, meteorology, National Weather Service, weather translation, jargon decoder">
    <meta name="google-site-verification" content="IdNCtGpFPAc0ZPT6T41Z-KgfP-AzHr7qfAn-7asX96Y">
    <link rel="canonical" href="https://plaincast.live">
    <script defer src="/_vercel/insights/script.js"></script>

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://plaincast.live">
    <meta property="og:title" content="Plaincast - NWS Forecasts, Decoded">
    <meta property="og:description" content="Area Forecast Discussions decoded into plain English. Side-by-side translation with 150+ term jargon glossary and confidence indicators.">
    <meta property="og:site_name" content="Plaincast">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Plaincast - NWS Forecasts, Decoded">
    <meta name="twitter:description" content="NWS Area Forecast Discussions decoded into plain English. Side-by-side translation, jargon glossary, confidence indicators.">

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Plaincast",
        "url": "https://plaincast.live",
        "description": "NWS Area Forecast Discussions decoded into plain English with side-by-side translation, 150+ term jargon glossary, forecaster confidence indicators, and smart abbreviation expansion.",
        "applicationCategory": "WeatherApplication",
        "operatingSystem": "Any",
        "browserRequirements": "Requires JavaScript",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "author": {
            "@type": "Person",
            "name": "Jonah Berg",
            "url": "https://github.com/notjbg"
        },
        "sourceOrganization": {
            "@type": "GovernmentOrganization",
            "name": "National Weather Service",
            "url": "https://www.weather.gov"
        },
        "featureList": [
            "Side-by-side plain English translation",
            "150+ term meteorological jargon glossary",
            "Forecaster confidence indicator",
            "Smart NWS abbreviation expansion",
            "Zulu to local time conversion",
            "Active weather alerts with detail view",
            "19 NWS forecast offices",
            "Key takeaway extraction"
        ]
    }
    </script>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
            {
                "@type": "Question",
                "name": "What is an Area Forecast Discussion (AFD)?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "An Area Forecast Discussion is a detailed narrative forecast written 3-4 times daily by National Weather Service meteorologists. Unlike weather apps that show icons and numbers, AFDs explain the reasoning behind the forecast - why models disagree, what forecasters are watching, and where uncertainty exists."
                }
            },
            {
                "@type": "Question",
                "name": "How does Plaincast translate NWS forecasts?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Plaincast expands NWS abbreviations into full words, converts Zulu (UTC) times to local time zones, translates meteorological shorthand into plain language, and highlights key information like days, temperatures, and hazard terms for quick scanning."
                }
            },
            {
                "@type": "Question",
                "name": "Which NWS offices does Plaincast support?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Plaincast supports 19 NWS forecast offices including Los Angeles (LOX), New York (OKX), Chicago (LOT), Houston (HGX), Phoenix (PSR), San Francisco (MTR), Miami (MFL), Seattle (SEW), Denver (BOU), and more."
                }
            }
        ]
    }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --text: #1c1917;
            --text-light: #78716c;
            --blue: #2563eb;
            --blue-light: #eff6ff;
            --border: #e7e5e4;
            --bg: #ffffff;
            --serif: Georgia, 'Times New Roman', serif;
            --mono: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            --sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            font-family: var(--serif);
            font-size: 17px;
            line-height: 1.7;
            color: var(--text);
            background: var(--bg);
        }

        /* Header */
        .header {
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 2rem 1rem;
        }
        .header h1 {
            font-family: var(--serif);
            font-size: 2rem;
            font-weight: 400;
            letter-spacing: -0.02em;
        }
        .header-row {
            display: flex;
            align-items: baseline;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .header select {
            font-family: var(--sans);
            font-size: 0.85rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.3rem 0.5rem;
            background: var(--bg);
            color: var(--text);
        }
        .issue-time {
            font-family: var(--sans);
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        .explainer {
            margin-top: 0.75rem;
            max-width: 680px;
        }
        .explainer summary {
            font-family: var(--sans);
            font-size: 0.8rem;
            color: var(--text-light);
            cursor: pointer;
            letter-spacing: 0.02em;
            list-style: none;
        }
        .explainer summary::-webkit-details-marker { display: none; }
        .explainer summary::before {
            content: '+ ';
            font-weight: 600;
        }
        .explainer[open] summary::before {
            content: '− ';
        }
        .explainer p {
            font-family: var(--sans);
            font-size: 0.85rem;
            line-height: 1.65;
            color: var(--text-light);
            margin-top: 0.5rem;
            font-style: italic;
        }

        /* Key Takeaway */
        .takeaway {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem 1.5rem;
        }
        .takeaway-box {
            background: var(--blue-light);
            border-left: 3px solid var(--blue);
            padding: 1.25rem 1.5rem;
            border-radius: 0 6px 6px 0;
        }
        .takeaway-label {
            font-family: var(--sans);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--blue);
            margin-bottom: 0.35rem;
        }
        .takeaway-text {
            font-size: 1.15rem;
            line-height: 1.6;
        }

        /* Confidence indicator */
        .confidence {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem 1rem;
        }
        .confidence-box {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
        }
        .confidence-label {
            font-family: var(--sans);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-light);
            white-space: nowrap;
        }
        .confidence-bar-wrap {
            flex: 1;
            max-width: 200px;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .confidence-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .confidence-text {
            font-family: var(--sans);
            font-size: 0.8rem;
            color: var(--text);
            font-weight: 500;
        }

        /* AI translation toggle */
        .ai-toggle {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .ai-toggle-btn {
            font-family: var(--sans);
            font-size: 0.8rem;
            padding: 0.3rem 0.85rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .ai-toggle-btn:hover {
            border-color: var(--text-light);
            color: var(--text);
        }
        .ai-toggle-btn.active {
            background: var(--blue-light);
            border-color: var(--blue);
            color: var(--blue);
        }
        .ai-toggle-label {
            font-family: var(--sans);
            font-size: 0.75rem;
            color: var(--text-light);
        }
        .ai-loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid var(--border);
            border-top-color: var(--blue);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .plain-col .ai-translated {
            border-left: 2px solid var(--blue);
            padding-left: 1rem;
            margin-left: -1rem;
        }

        /* Section nav */
        .section-nav {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem 1.5rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .section-nav a {
            font-family: var(--sans);
            font-size: 0.8rem;
            color: var(--text-light);
            text-decoration: none;
            padding: 0.25rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 999px;
            transition: all 0.15s;
        }
        .section-nav a:hover {
            color: var(--text);
            border-color: var(--text-light);
        }

        /* Sections */
        .sections {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem 4rem;
        }
        .forecast-section {
            margin-bottom: 3rem;
        }
        .section-title {
            font-family: var(--sans);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-light);
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1.25rem;
        }
        .columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2.5rem;
        }
        @media (max-width: 768px) {
            .columns { grid-template-columns: 1fr; gap: 1.5rem; }
            .header, .takeaway, .section-nav, .sections { padding-left: 1.25rem; padding-right: 1.25rem; }
            .header h1 { font-size: 1.5rem; }
        }

        .col-label {
            font-family: var(--sans);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-light);
            margin-bottom: 0.75rem;
        }

        /* Plain English column */
        .plain-col p {
            margin-bottom: 1rem;
        }
        .plain-col .sub-header {
            font-family: var(--sans);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            margin: 1.5rem 0 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--border);
        }
        .plain-col .sub-header:first-child {
            margin-top: 0;
        }
        .plain-col .alert-list {
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .plain-col .alert-list li {
            font-family: var(--sans);
            font-size: 0.82rem;
            line-height: 1.5;
            padding: 0.6rem 0.85rem;
            border-radius: 6px;
            border-left: 3px solid;
        }
        .plain-col .alert-list li.alert-warning {
            background: #fef2f2;
            border-left-color: #dc2626;
            color: #991b1b;
        }
        .plain-col .alert-list li.alert-watch {
            background: #fff7ed;
            border-left-color: #d97706;
            color: #92400e;
        }
        .plain-col .alert-list li.alert-advisory {
            background: #eff6ff;
            border-left-color: #2563eb;
            color: #1e40af;
        }
        .plain-col .alert-list li.alert-statement {
            background: #f5f5f4;
            border-left-color: #78716c;
            color: #44403c;
        }
        .alert-link {
            color: #1a6bb5;
            text-decoration: underline;
            text-decoration-color: rgba(26, 107, 181, 0.4);
            text-underline-offset: 2px;
            display: block;
            cursor: pointer;
            background: none;
            border: none;
            font: inherit;
            padding: 0;
            text-align: left;
            width: 100%;
        }
        .alert-link:hover {
            text-decoration-color: #1a6bb5;
        }
        .alert-link:focus-visible {
            outline: 2px solid var(--blue);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Alert detail modal */
        .alert-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .alert-modal-overlay.open {
            display: flex;
        }
        .alert-modal {
            background: #fff;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 2rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            position: relative;
            font-family: var(--serif);
        }
        .alert-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            line-height: 1;
        }
        .alert-modal-close:hover { color: #222; }
        .alert-modal h3 {
            margin: 0 0 0.5rem;
            font-size: 1.2rem;
            line-height: 1.3;
        }
        .alert-modal .alert-meta {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 1rem;
            font-family: var(--sans);
        }
        .alert-modal .alert-body {
            font-size: 0.95rem;
            line-height: 1.7;
            white-space: pre-wrap;
        }
        .alert-modal .alert-instruction {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e0e0e0;
            font-weight: 500;
        }

        /* Annotated column */
        .annotated-col {
            font-family: var(--mono);
            font-size: 0.82rem;
            line-height: 1.65;
            color: #44403c;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Jargon highlights */
        .jargon {
            background: #fef9c3;
            border-bottom: 1px dashed #ca8a04;
            cursor: help;
            padding: 0 2px;
            border-radius: 2px;
            position: relative;
        }
        .jargon:hover { background: #fef08a; }
        .jargon .tip {
            display: none;
            position: absolute;
            bottom: calc(100% + 6px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--text);
            color: #fff;
            font-family: var(--sans);
            font-size: 0.78rem;
            line-height: 1.4;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            width: max-content;
            max-width: 280px;
            z-index: 100;
            white-space: normal;
            font-weight: 400;
        }
        .jargon:hover .tip, .jargon.tip-open .tip { display: block; }

        /* Loading / error */
        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
            font-family: var(--sans);
            font-size: 0.95rem;
        }

        /* Footer */
        .footer {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            border-top: 1px solid var(--border);
            font-family: var(--sans);
            font-size: 0.8rem;
            color: var(--text-light);
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .footer a { color: var(--text-light); }
    </style>
</head>
<body>

<div class="header">
    <div class="header-row">
        <h1>Plaincast</h1>
        <select id="office-select">
            <option value="LOX">Los Angeles (LOX)</option>
            <option value="OKX">New York (OKX)</option>
            <option value="LOT">Chicago (LOT)</option>
            <option value="HGX">Houston (HGX)</option>
            <option value="PSR">Phoenix (PSR)</option>
            <option value="PHI">Philadelphia (PHI)</option>
            <option value="FWD">Dallas / Fort Worth (FWD)</option>
            <option value="EWX">San Antonio (EWX)</option>
            <option value="SGX">San Diego (SGX)</option>
            <option value="MTR">San Francisco (MTR)</option>
            <option value="MFL">Miami (MFL)</option>
            <option value="FFC">Atlanta (FFC)</option>
            <option value="LWX">Washington, DC (LWX)</option>
            <option value="BOX">Boston (BOX)</option>
            <option value="BOU">Denver (BOU)</option>
            <option value="SEW">Seattle (SEW)</option>
            <option value="PQR">Portland (PQR)</option>
            <option value="VEF">Las Vegas (VEF)</option>
            <option value="HNX">Central CA / Hanford (HNX)</option>
        </select>
    </div>
    <div class="issue-time" id="issue-time"></div>
    <details class="explainer">
        <summary>What is this?</summary>
        <p>Area Forecast Discussions are the real forecasts, written 3 to 4 times daily by NWS meteorologists reading the models and interpreting what they mean for your area. They offer far deeper insight than any weather app, but they're written in dense meteorological shorthand. Plaincast uses Anthropic's Claude to summarize them into plain English, side by side with the annotated original.</p>
    </details>
</div>

<div class="takeaway" id="takeaway-container" style="display:none">
    <div class="takeaway-box">
        <div class="takeaway-label">Key Takeaway</div>
        <div class="takeaway-text" id="takeaway-text"></div>
    </div>
</div>

<div class="confidence" id="confidence-container" style="display:none">
    <div class="confidence-box">
        <div class="confidence-label">Forecaster Confidence</div>
        <div class="confidence-bar-wrap">
            <div class="confidence-bar" id="confidence-bar"></div>
        </div>
        <div class="confidence-text" id="confidence-text"></div>
    </div>
</div>

<nav class="section-nav" id="section-nav"></nav>

<div class="sections" id="sections">
    <div class="loading" id="loading">Loading forecast…</div>
</div>

<div class="footer">
    <span>Data: <a href="https://www.weather.gov" target="_blank" rel="noopener noreferrer">NWS <span id="footer-office">LOX</span></a></span>
    <span>Summaries powered by <a href="https://www.anthropic.com/claude/haiku" target="_blank" rel="noopener noreferrer">Claude</a></span>
    <a href="" id="raw-link" target="_blank" rel="noopener noreferrer">View raw AFD</a>
    <a href="https://github.com/notjbg/plaincast" target="_blank" rel="noopener noreferrer">GitHub</a>
    <span style="margin-left:auto">Built by <a href="https://github.com/notjbg" target="_blank" rel="noopener noreferrer">Jonah Berg</a></span>
</div>

<script>
// ─── Jargon Glossary ───────────────────────────────────────────────
const GLOSSARY = {
    // Pressure levels & heights
    'dam': 'Decameters — unit for geopotential height on upper-air charts',
    '500mb': '500 millibars — roughly 18,000 ft; a key level for steering weather systems',
    '500 mb': '500 millibars — roughly 18,000 ft; a key level for steering weather systems',
    '300mb': '300 millibars — roughly 30,000 ft; jet stream level',
    '300 mb': '300 millibars — roughly 30,000 ft; jet stream level',
    '700mb': '700 millibars — roughly 10,000 ft; used for moisture analysis',
    '700 mb': '700 millibars — roughly 10,000 ft; used for moisture analysis',
    '850mb': '850 millibars — roughly 5,000 ft; low-level temperature/moisture',
    '850 mb': '850 millibars — roughly 5,000 ft; low-level temperature/moisture',
    '250mb': '250 millibars — roughly 34,000 ft; upper jet stream',
    '250 mb': '250 millibars — roughly 34,000 ft; upper jet stream',
    '200mb': '200 millibars — roughly 39,000 ft; top of troposphere',
    '925mb': '925 millibars — roughly 2,500 ft; near-surface analysis',

    // Precipitation & moisture
    'PWAT': 'Precipitable Water — total water vapor in a column of atmosphere',
    'PWATs': 'Precipitable Water values',
    'QPF': 'Quantitative Precipitation Forecast — predicted rainfall amounts',
    'PoP': 'Probability of Precipitation',
    'POPS': 'Probability of Precipitation',
    'IVT': 'Integrated Vapor Transport — measure of atmospheric river strength',

    // Instability & convection
    'CAPE': 'Convective Available Potential Energy — fuel for thunderstorms',
    'CIN': 'Convective Inhibition — a cap that suppresses thunderstorms',
    'LI': 'Lifted Index — stability measure; negative = more unstable',
    'TSTM': 'Thunderstorm',
    'TSTMS': 'Thunderstorms',
    'tstm': 'Thunderstorm',
    'tstms': 'Thunderstorms',
    'convection': 'Rising air producing clouds/storms, often meaning thunderstorms',
    'convective': 'Related to rising air and thunderstorm development',
    'MCS': 'Mesoscale Convective System — large organized thunderstorm complex',
    'supercell': 'A severe rotating thunderstorm',
    'mesocyclone': 'A rotating updraft within a supercell thunderstorm',

    // Dynamics & synoptic
    'vort': 'Vorticity — spin in the atmosphere; positive vort = rising motion',
    'vort lobe': 'A concentrated area of atmospheric spin that can trigger storms',
    'PVA': 'Positive Vorticity Advection — spin moving in, often triggers rising air',
    'NVA': 'Negative Vorticity Advection — spin moving out, often triggers sinking air',
    'trof': 'Trough — an elongated area of low pressure',
    'trough': 'An elongated area of low pressure bringing unsettled weather',
    'ridge': 'An elongated area of high pressure bringing fair weather',
    'ridging': 'Building high pressure',
    'zonal': 'West-to-east flow pattern — generally less active weather',
    'meridional': 'North-south flow pattern — more active, extreme weather',
    'shortwave': 'A small-scale trough moving through the larger flow pattern',
    'longwave': 'A large-scale trough or ridge spanning thousands of miles',
    'jet': 'Jet stream — fast-moving river of air at 30,000+ ft',
    'jet streak': 'An area of maximum winds within the jet stream',
    'upper-level': 'High in the atmosphere, typically 18,000 ft and above',
    'low-level': 'Near the surface, below about 10,000 ft',
    'subtropical jet': 'A jet stream near 25-30°N latitude',
    'polar jet': 'A jet stream near 40-60°N latitude',
    'diffluence': 'Air spreading apart aloft — supports rising motion',
    'confluence': 'Air coming together aloft — supports sinking motion',
    'divergence': 'Air spreading out — at the surface causes low pressure',
    'convergence': 'Air coming together — at the surface causes rising motion',
    'omega': 'Vertical motion in the atmosphere (omega equation)',
    'WAA': 'Warm Air Advection — warm air moving in',
    'CAA': 'Cold Air Advection — cold air moving in',

    // Fronts & boundaries
    'OFB': 'Outflow Boundary — a gust front from a thunderstorm',
    'FROPA': 'Frontal Passage — a front moving through the area',
    'frontal passage': 'A weather front moving through, bringing wind/temperature changes',
    'cold front': 'Leading edge of advancing cold air',
    'warm front': 'Leading edge of advancing warm air',
    'occluded front': 'Where a cold front has caught up to a warm front',
    'stationary front': 'A front that is not moving',
    'dryline': 'Boundary between moist and dry air; can trigger storms',
    'SFC': 'Surface',
    'sfc': 'Surface',

    // Aviation
    'MVFR': 'Marginal VFR — ceiling 1,000–3,000 ft or visibility 3–5 miles',
    'IFR': 'Instrument Flight Rules — ceiling 500–1,000 ft or visibility 1–3 miles',
    'LIFR': 'Low IFR — ceiling below 500 ft or visibility below 1 mile',
    'VFR': 'Visual Flight Rules — ceiling above 3,000 ft and visibility above 5 miles',
    'TAF': 'Terminal Aerodrome Forecast — airport-specific weather forecast',
    'GDP': 'Ground Delay Program — FAA program delaying flights to a destination',
    'GS': 'Ground Stop — all flights to an airport halted temporarily',
    'METAR': 'Routine aviation weather observation report',
    'SPECI': 'Special (unscheduled) aviation weather observation',
    'SIGMET': 'Significant Meteorological Information — advisory for severe weather',
    'AIRMET': 'Airmen\'s Meteorological Information — advisory for moderate weather',
    'PIREP': 'Pilot Report of actual flight conditions',
    'CIG': 'Ceiling — height of the lowest broken/overcast cloud layer',
    'cig': 'Ceiling — height of the lowest broken/overcast cloud layer',
    'CIGS': 'Ceilings',
    'cigs': 'Ceilings',
    'VSBY': 'Visibility',
    'vsby': 'Visibility',
    'TURB': 'Turbulence',

    // Sky conditions
    'BKN': 'Broken — 5/8 to 7/8 cloud cover',
    'OVC': 'Overcast — 8/8 cloud cover (complete)',
    'SCT': 'Scattered — 3/8 to 4/8 cloud cover',
    'FEW': 'Few — 1/8 to 2/8 cloud cover',
    'CLR': 'Clear — no clouds',
    'SKC': 'Sky Clear',

    // Heights
    'AGL': 'Above Ground Level',
    'MSL': 'Mean Sea Level',
    'FL': 'Flight Level — altitude in hundreds of feet based on standard pressure',

    // Airport codes
    'KLAX': 'Los Angeles International Airport',
    'KBUR': 'Burbank Airport',
    'KSNA': 'John Wayne / Orange County Airport',
    'KVNY': 'Van Nuys Airport',
    'KSMO': 'Santa Monica Airport',
    'KONT': 'Ontario International Airport',
    'KSBA': 'Santa Barbara Airport',
    'KOXR': 'Oxnard / Ventura County Airport',
    'KLGB': 'Long Beach Airport',
    'KPSP': 'Palm Springs Airport',
    'KSAN': 'San Diego International Airport',
    'KSFO': 'San Francisco International Airport',
    'KJFK': 'John F. Kennedy International Airport',
    'KSEA': 'Seattle-Tacoma International Airport',

    // Marine
    'SCA': 'Small Craft Advisory — hazardous conditions for small boats',
    'GALE': 'Gale Warning — sustained winds 34–47 knots',
    'gale warning': 'Sustained winds 34–47 knots on the water',
    'storm warning': 'Sustained winds 48–63 knots on the water',
    'hurricane force': 'Sustained winds 64+ knots on the water',
    'seas': 'Combined wave height (wind waves + swell)',
    'swell': 'Waves generated by distant weather systems',
    'wind waves': 'Waves generated by local winds',
    'chop': 'Short, steep wind waves',
    'KTS': 'Knots — nautical miles per hour',
    'kts': 'Knots — nautical miles per hour',
    'kt': 'Knot — one nautical mile per hour',
    'NM': 'Nautical Miles',

    // Abbreviations (general)
    'chc': 'Chance',
    'csts': 'Coasts',
    'vlys': 'Valleys',
    'mtns': 'Mountains',
    'wnds': 'Winds',
    'temps': 'Temperatures',
    'temp': 'Temperature',
    'pcpn': 'Precipitation',
    'precip': 'Precipitation',
    'max': 'Maximum',
    'min': 'Minimum',
    'aftn': 'Afternoon',
    'mrng': 'Morning',
    'eve': 'Evening',
    'erly': 'Early',
    'thru': 'Through',
    'btwn': 'Between',
    'isol': 'Isolated',
    'sct': 'Scattered',
    'num': 'Numerous',
    'ocnl': 'Occasional',
    'intmt': 'Intermittent',
    'cont': 'Continue/continuing',
    'incr': 'Increase/increasing',
    'decr': 'Decrease/decreasing',
    'devel': 'Develop/developing',
    'dvlpg': 'Developing',
    'wrn': 'Western',
    'ern': 'Eastern',
    'nrn': 'Northern',
    'srn': 'Southern',
    'cntrl': 'Central',
    'fcst': 'Forecast',
    'NBM': 'National Blend of Models — a consensus forecast model',
    'GFS': 'Global Forecast System — American global weather model',
    'ECMWF': 'European Centre model — often considered most accurate global model',
    'NAM': 'North American Mesoscale — regional weather model',
    'HRRR': 'High-Resolution Rapid Refresh — hourly updated short-range model',
    'RAP': 'Rapid Refresh — hourly updated model',
    'HREF': 'High-Resolution Ensemble Forecast',
    'ensembles': 'Multiple model runs showing range of possible outcomes',
    'ensemble': 'Multiple model runs showing range of possible outcomes',
    'hi res': 'High resolution models — more detailed, shorter range',
    'deterministic': 'A single model run (vs ensemble of many runs)',
    'climo': 'Climatology — historical average conditions',
    'climatological': 'Based on historical weather averages for the location/date',
    'anom': 'Anomaly — departure from the historical average',
    'above normal': 'Higher than the historical average for the date',
    'below normal': 'Lower than the historical average for the date',
    'near normal': 'Close to the historical average for the date',

    // Time references
    'Z': 'Zulu time (UTC) — subtract 8 hours for PST, 7 for PDT',
    'UTC': 'Coordinated Universal Time — the global time standard',
    '00Z': 'Midnight UTC (4 PM PST / 5 PM PDT)',
    '06Z': '6 AM UTC (10 PM PST / 11 PM PDT)',
    '12Z': 'Noon UTC (4 AM PST / 5 AM PDT)',
    '18Z': '6 PM UTC (10 AM PST / 11 AM PDT)',

    // Wind & pressure
    'SLP': 'Sea Level Pressure',
    'mb': 'Millibars — unit of atmospheric pressure',
    'hPa': 'Hectopascals — same as millibars',
    'gusts': 'Brief, sudden increases in wind speed',

    // Phenomena
    'AR': 'Atmospheric River — a plume of tropical moisture',
    'atmospheric river': 'A plume of tropical moisture bringing heavy rain',
    'Pineapple Express': 'Atmospheric river originating near Hawaii',
    'Santa Ana': 'Hot, dry offshore winds in Southern California',
    'Diablo winds': 'Hot, dry offshore winds in the San Francisco Bay Area',
    'Sundowner': 'Hot, dry downslope winds on the south coast of Santa Barbara',
    'marine layer': 'Cool, moist air from the ocean, often bringing low clouds/fog',
    'onshore flow': 'Wind blowing from the ocean toward land — cooler, moister',
    'offshore flow': 'Wind blowing from land toward the ocean — warmer, drier',
    'subsidence': 'Sinking air in the atmosphere — brings clearing and warming',
    'inversion': 'Temperature increasing with height, trapping cool/polluted air below',
    'lee trough': 'Low pressure area forming downwind of mountains',
    'Catalina Eddy': 'A counter-clockwise circulation off the SoCal coast bringing clouds',
    'eddy': 'A circulation pattern, often bringing clouds to coastal areas',
    'upslope': 'Air moving up a mountain slope — can trigger clouds/precip',
    'downslope': 'Air moving down a mountain slope — warming and drying',
    'orographic': 'Weather effects caused by mountains (lifting, blocking, etc.)',
    'lapse rate': 'Rate of temperature decrease with altitude — steeper = more unstable',
    'NEXRAD': 'Next-Generation Radar — the NWS Doppler radar network',
    'RH': 'Relative Humidity',
    'dewpoint': 'Temperature at which air becomes saturated — higher = more humid',
    'mixing ratio': 'Amount of water vapor in the air by weight',
    'theta-e': 'Equivalent potential temperature — combines temperature and moisture',
    'snow level': 'Altitude where precipitation changes from rain to snow',
    'freezing level': 'Altitude where temperature reaches 32°F / 0°C',
    'SWE': 'Snow Water Equivalent — water content of snowpack',
    'PTYPE': 'Precipitation Type (rain, snow, sleet, freezing rain)',
    'graupel': 'Soft hail / snow pellets — forms in convective clouds',
    'virga': 'Precipitation that evaporates before reaching the ground',
    'dry punch': 'A surge of dry air that can suppress precipitation',
    'moisture plume': 'A band of high atmospheric moisture',
    'wrap-around moisture': 'Moisture wrapping around the backside of a low pressure system',

    // Warnings & watches
    'PDS': 'Particularly Dangerous Situation',
    'SVR': 'Severe thunderstorm',
    'TOR': 'Tornado',
    'FFW': 'Flash Flood Warning',
    'HWO': 'Hazardous Weather Outlook',
    'red flag': 'Red Flag Warning — critical fire weather conditions',
    'fire weather watch': 'Conditions may develop for critical fire weather',

    // Misc
    'CWA': 'County Warning Area — the NWS office\'s forecast territory',
    'WFO': 'Weather Forecast Office',
    'NWS': 'National Weather Service',
    'NDFD': 'National Digital Forecast Database',
    'MOS': 'Model Output Statistics',
    'sounding': 'A vertical profile of temperature, moisture, and wind',
    'RAOB': 'Radiosonde observation — weather balloon data',
    'prog': 'Prognostic chart — a forecast map',
    'synoptic': 'Large-scale weather patterns (hundreds to thousands of miles)',
    'mesoscale': 'Medium-scale weather features (tens to hundreds of miles)',
    'microscale': 'Small-scale weather features (under 10 miles)',
    'diurnal': 'Daily cycle — daytime heating, nighttime cooling',
    'nocturnal': 'Occurring at night',
    'fetch': 'Distance over water that wind blows — longer = bigger waves',
    'inland': 'Away from the coast, toward the interior',
    'coastal': 'Near the ocean shoreline',
    'NW flow': 'Northwest flow — air moving from the northwest, often cool and dry',
    'SW flow': 'Southwest flow — air moving from the southwest, often warm and moist',
    'SE flow': 'Southeast flow — air from the southeast, can bring moisture',
    'NE flow': 'Northeast flow — air from the northeast, often associated with offshore/Santa Ana winds',
};

// ─── Office timezone mapping ────────────────────────────────────────
const OFFICE_TIMEZONES = {
    'LOX': 'America/Los_Angeles',
    'SGX': 'America/Los_Angeles',
    'HNX': 'America/Los_Angeles',
    'MTR': 'America/Los_Angeles',
    'SEW': 'America/Los_Angeles',
    'PQR': 'America/Los_Angeles',
    'VEF': 'America/Los_Angeles',
    'OKX': 'America/New_York',
    'PHI': 'America/New_York',
    'BOX': 'America/New_York',
    'MFL': 'America/New_York',
    'FFC': 'America/New_York',
    'LWX': 'America/New_York',
    'LOT': 'America/Chicago',
    'HGX': 'America/Chicago',
    'FWD': 'America/Chicago',
    'EWX': 'America/Chicago',
    'PSR': 'America/Phoenix',
    'BOU': 'America/Denver',
};
let currentOffice = 'LOX';
let fetchGeneration = 0; // race condition guard for rapid office switching
let issueTimeDate = null; // for auto-updating "X ago"

// Office → state for alerts API
const OFFICE_STATES = {
    'LOX': 'CA', 'SGX': 'CA', 'HNX': 'CA', 'MTR': 'CA',
    'OKX': 'NY', 'PHI': 'PA', 'BOX': 'MA', 'LWX': 'VA',
    'MFL': 'FL', 'FFC': 'GA',
    'LOT': 'IL', 'HGX': 'TX', 'FWD': 'TX', 'EWX': 'TX',
    'PSR': 'AZ', 'BOU': 'CO',
    'SEW': 'WA', 'PQR': 'OR', 'VEF': 'NV',
};

// Office → sender name fragment for matching alerts
const OFFICE_SENDER = {
    'LOX': 'Los Angeles', 'SGX': 'San Diego', 'HNX': 'Hanford', 'MTR': 'San Francisco',
    'OKX': 'New York', 'PHI': 'Mount Holly', 'BOX': 'Boston', 'LWX': 'Baltimore',
    'MFL': 'Miami', 'FFC': 'Peachtree',
    'LOT': 'Chicago', 'HGX': 'Houston', 'FWD': 'Fort Worth', 'EWX': 'San Antonio',
    'PSR': 'Phoenix', 'BOU': 'Denver',
    'SEW': 'Seattle', 'PQR': 'Portland', 'VEF': 'Las Vegas',
};

// Fetch live alerts and return map of event name → alert URL
async function fetchAlerts(office) {
    const state = OFFICE_STATES[office];
    if (!state) return {};
    try {
        const res = await fetch(`https://api.weather.gov/alerts/active?area=${state}`, {
            headers: { 'User-Agent': 'Plaincast/1.0 (plaincast.live)' }
        });
        if (!res.ok) return {};
        const data = await res.json();
        const senderMatch = OFFICE_SENDER[office] || '';
        const alertMap = {};
        for (const f of (data.features || [])) {
            const p = f.properties;
            // Match alerts from this office
            if (senderMatch && !(p.senderName || '').includes(senderMatch)) continue;
            const event = p.event;
            if (!alertMap[event]) {
                alertMap[event] = {
                    headline: p.headline || event,
                    description: p.description || '',
                    instruction: p.instruction || '',
                    severity: p.severity || '',
                    expires: p.expires || '',
                    areaDesc: p.areaDesc || ''
                };
            }
        }
        return alertMap;
    } catch(e) { console.warn('Alert fetch failed', e); return {}; }
}

let currentAlerts = {};

// ─── Section parsing ───────────────────────────────────────────────
const SECTION_NAMES = {
    'SYNOPSIS': 'Synopsis',
    'DISCUSSION': 'Synopsis',
    'SHORT TERM': 'Short Term',
    'NEAR TERM': 'Short Term',
    'LONG TERM': 'Long Term',
    'EXTENDED': 'Long Term',
    'AVIATION': 'Aviation',
    'MARINE': 'Marine',
    'BEACHES': 'Beaches',
    'FIRE WEATHER': 'Fire Weather',
    'LOX WATCHES/WARNINGS/ADVISORIES': 'Active Alerts',
    'WATCHES/WARNINGS/ADVISORIES': 'Active Alerts',
};

function parseSections(text) {
    // Remove header lines (product header, timestamps at very top)
    const lines = text.split('\n');
    const sections = [];
    let currentKey = null;
    let currentLines = [];
    let forecaster = '';

    for (const line of lines) {
        // Check for section headers: .SYNOPSIS..., .SHORT TERM (TDY-TUE)..., .LOX WATCHES/WARNINGS/ADVISORIES...
        // Try with office prefix first (3-letter like LOX, SGX)
        const headerMatch = line.match(/^\.[A-Z]{3}\s+([A-Z\s\/]+?)(?:\s*\([^)]*\))?\s*\.{2,3}/)
            || line.match(/^\.([A-Z\s\/]+?)(?:\s*\([^)]*\))?\s*\.{2,3}/);
        if (headerMatch) {
            if (currentKey) {
                sections.push({ key: currentKey, text: currentLines.join('\n').trim() });
            }
            const rawKey = headerMatch[1].trim();
            // Map to canonical name
            currentKey = SECTION_NAMES[rawKey] || rawKey.charAt(0) + rawKey.slice(1).toLowerCase();
            currentLines = [line.replace(headerMatch[0], '').trim()];
            continue;
        }
        // Check for $$ delimiter (end of section / forecaster signature)
        if (line.trim() === '$$') {
            if (currentKey) {
                sections.push({ key: currentKey, text: currentLines.join('\n').trim() });
                currentKey = null;
                currentLines = [];
            }
            continue;
        }
        // Forecaster line
        if (line.match(/^&&$/)) continue;
        if (currentKey) {
            currentLines.push(line);
        }
        // Try to find forecaster
        const fMatch = line.match(/^\.?(?:Forecaster|FORECASTER)[:\s]+(.+)/i);
        if (fMatch) forecaster = fMatch[1].trim();
    }
    if (currentKey) {
        sections.push({ key: currentKey, text: currentLines.join('\n').trim() });
    }

    // Clean up: remove forecaster lines from section text, remove trailing &&
    for (const s of sections) {
        s.text = s.text.replace(/&&\s*$/, '').replace(/^\s*&&\s*/gm, '').trim();
        // Extract forecaster if embedded at end
        const fm = s.text.match(/\n\s*(?:Forecaster|FORECASTER)[:\s]*(.+)$/im);
        if (fm) {
            if (!forecaster) forecaster = fm[1].trim();
            s.text = s.text.replace(fm[0], '').trim();
        }
    }

    return { sections, forecaster };
}

// ─── Plain English translation ─────────────────────────────────────
function translateToPlainEnglish(text) {
    let t = text;

    // Remove NWS timestamps like "15/913 AM.", "15/935 AM.", "15/1801Z.", "15/1002 AM."
    t = t.replace(/\d{2}\/\d{3,4}\s*(?:AM|PM|Z)\.?\s*/gi, '');

    // Remove NWS product code references and "see the CFWLOX..." sentences
    t = t.replace(/,?\s*see\s+the\s+[A-Z]{3,12}\s+(?:and\s+[A-Z]{3,12}\s+)?products?\s+for\s+more\s+details\.?/gi, '.');
    t = t.replace(/\b(?:See\s+)?(?:Lax|Cfw|Srf|Npw|Mww|Wsw|Ffa)[a-z]{2,8}\b\.?/gi, '');

    // Remove zone number lists (e.g., "for zones 38-344-345-353...")
    t = t.replace(/for\s+zones?\s+[\d\->]+/gi, '');

    // Remove raw NWS product references in parens, and empty parens
    t = t.replace(/\(See\s+[A-Za-z]+\)/gi, '');
    t = t.replace(/\(\s*\)/g, '');

    // Convert ***Header*** to sub-section markers (before collapsing whitespace)
    t = t.replace(/\*{3}\s*([^*]+?)\s*\*{3}/g, '\n\n§§§$1§§§\n\n');

    // Remove embedded sub-section headers like ".SHORT TERM (TDY-TUE)..." that leak through
    t = t.replace(/\.(?:SHORT|LONG|NEAR)\s+TERM\s*\([^)]*\)\.\s*/gi, '');

    // Remove NWS formatting artifacts
    t = t.replace(/\.{3,}/g, '. ');
    // Collapse runs of spaces (but preserve newlines for paragraph splitting)
    t = t.replace(/[ \t]{2,}/g, ' ');

    // Expand abbreviations
    const abbrevs = [
        // General weather abbreviations
        [/\bchc\b/gi, 'chance'],
        [/\bcsts\b/gi, 'coasts'],
        [/\bvlys\b/gi, 'valleys'],
        [/\bmtns\b/gi, 'mountains'],
        [/\bwnds\b/gi, 'winds'],
        [/\btemps\b/gi, 'temperatures'],
        [/\bpcpn\b/gi, 'precipitation'],
        [/\bprecip\b/gi, 'precipitation'],
        [/\baftn\b/gi, 'afternoon'],
        [/\bmrng\b/gi, 'morning'],
        [/\berly\b/gi, 'early'],
        [/\bthru\b/gi, 'through'],
        [/\bbtwn\b/gi, 'between'],
        [/\bisol\b/gi, 'isolated'],
        [/\bnum\b/gi, 'numerous'],
        [/\bocnl\b/gi, 'occasional'],
        [/\bintmt\b/gi, 'intermittent'],
        [/\bcont\b/gi, 'continue'],
        [/\bincr\b/gi, 'increase'],
        [/\bdecr\b/gi, 'decrease'],
        [/\bdevel\b/gi, 'develop'],
        [/\bdvlpg\b/gi, 'developing'],
        [/\bwrn\b/gi, 'western'],
        [/\bsrn\b/gi, 'southern'],
        [/\bnrn\b/gi, 'northern'],
        [/\bcntrl\b/gi, 'central'],
        [/\bfcst\b/gi, 'forecast'],
        [/\bblo\b/gi, 'below'],
        [/\babv\b/gi, 'above'],
        [/\bxtrm\b/gi, 'extreme'],
        [/\bposs\b/gi, 'possible'],
        [/\bprob\b/gi, 'probable'],

        // County/region abbreviations (California-specific)
        [/\bSLO\b/g, 'San Luis Obispo'],
        [/\bSBA\b/g, 'Santa Barbara'],
        [/\bVTA\b/g, 'Ventura'],
        [/\bLA\s+(?:county|basin|area|metro|coast|mountains?|foothills|valleys?)\b/gi, (m) => 'Los Angeles' + m.slice(2)],

        // Storm & dynamics
        [/\bTSTMS?\b/gi, 'thunderstorms'],
        [/\bSFC\b/g, 'surface'],
        [/\bsfc\b/g, 'surface'],
        [/\btrof\b/gi, 'trough'],
        [/\bPWATs?\b/g, 'precipitable water'],
        [/\bQPF\b/g, 'expected rainfall'],
        [/\bPoPs?\b/gi, 'chance of rain'],
        [/\bCAPE\b/g, 'storm energy'],
        [/\bCIN\b/g, 'convective cap'],
        [/\bRH\b/g, 'humidity'],
        [/\bSLP\b/g, 'sea level pressure'],

        // Models → friendly names
        [/\bNBM\b/g, 'the blend-of-models forecast'],
        [/\bHRRR\b/g, 'the high-res rapid-refresh model'],
        [/\bGFS\b/g, 'the American global model'],
        [/\bECMWF\b/g, 'the European model'],
        [/\bNAM\b/g, 'the regional model'],
        [/\bhi\s+res\b/gi, 'high-resolution'],
        [/\bclimo\b/gi, 'the historical average'],
        [/\bdiurnal\b/gi, 'daily'],
        [/\bnocturnal\b/gi, 'nighttime'],

        // Aviation
        [/\bMVFR\b/g, 'marginal visual flying conditions'],
        [/\bLIFR\b/g, 'very low visibility flying conditions'],
        [/\bIFR\b/g, 'instrument-only flying conditions'],
        [/\bVFR\b/g, 'good visual flying conditions'],
        [/\bTAFs?\b/g, 'airport forecasts'],
        [/\bGDP\b/g, 'ground delay program'],
        [/\bCIGS?\b/gi, 'ceilings'],
        [/\bVSBY\b/gi, 'visibility'],
        [/\bCLR\b/g, 'clear skies'],
        [/\bAGL\b/g, 'above ground'],
        [/\bMSL\b/g, 'above sea level'],
        [/\bFL\s*(\d{2,3})\b/g, 'flight level $1'],

        // Sky conditions with optional height numbers: BKN015 → broken clouds at 1,500 ft
        [/\bBKN(\d{3})\b/g, (_, h) => `broken clouds at ${parseInt(h)*100} ft`],
        [/\bOVC(\d{3})\b/g, (_, h) => `overcast at ${parseInt(h)*100} ft`],
        [/\bSCT(\d{3})\b/g, (_, h) => `scattered clouds at ${parseInt(h)*100} ft`],
        [/\bFEW(\d{3})\b/g, (_, h) => `few clouds at ${parseInt(h)*100} ft`],
        [/\bBKN\b/g, 'broken clouds'],
        [/\bOVC\b/g, 'overcast'],
        [/\bSCT\b/g, 'scattered clouds'],
        [/\bFEW\b/g, 'few clouds'],

        // Marine
        [/\bSCA\b/g, 'small craft advisory'],
        [/\bGALE\b/g, 'gale warning'],
        [/\bKTS\b/gi, 'knots'],
        [/\bkt\b/gi, 'knot'],
        [/\bNM\b/g, 'nautical miles'],

        // Airport codes to names
        [/\bKLAX\b/g, 'LAX'],
        [/\bKBUR\b/g, 'Burbank'],
        [/\bKSNA\b/g, 'Orange County'],
        [/\bKVNY\b/g, 'Van Nuys'],
        [/\bKSMO\b/g, 'Santa Monica'],
        [/\bKONT\b/g, 'Ontario'],
        [/\bKSBA\b/g, 'Santa Barbara'],
        [/\bKOXR\b/g, 'Oxnard'],
        [/\bKLGB\b/g, 'Long Beach'],
        [/\bKSAN\b/g, 'San Diego'],
        [/\bKPMD\b/g, 'Palmdale'],
        [/\bKWJF\b/g, 'Lancaster'],

        // Phenomena
        [/\b(?:an?\s+)?AR\b(?=\s+(?:event|will|is|was|pattern|plume|moving|hitting|arriving|developing|tapping))/g, 'atmospheric river'],
        [/\bIVT\b/g, 'moisture transport'],
        [/\bPDS\b/g, 'particularly dangerous'],
        [/\bSWE\b/g, 'snow water content'],

        // Previously leaked abbreviations
        [/\bLI\s+(?:values?|of|around|near|is|will)\b/gi, (m) => 'lifted index' + m.slice(2)],
        [/\bOFB\b/g, 'outflow boundary'],
        [/\bFROPA\b/g, 'frontal passage'],
        // GS only in aviation context — handled via glossary tooltip only
        [/\bUTC\b/g, 'UTC'],
        [/\bWFO\b/g, 'Weather Forecast Office'],
        [/\bCWA\b/g, 'forecast area'],
        [/\bRAOB\b/g, 'weather balloon data'],
        [/\bMOS\b/g, 'model output statistics'],
        [/\bNW\s+flow\b/gi, 'northwest flow'],
        [/\bSW\s+flow\b/gi, 'southwest flow'],
        [/\bSE\s+flow\b/gi, 'southeast flow'],
        [/\bNE\s+flow\b/gi, 'northeast flow'],
    ];

    for (const [pat, rep] of abbrevs) {
        t = t.replace(pat, rep);
    }

    // Convert Zulu time references: 18Z → local time (DST-aware)
    t = t.replace(/\b(\d{2,4})Z\b/g, (_, h) => {
        const utcHour = parseInt(h.length <= 2 ? h : h.substring(0, 2));
        const utcMin = h.length > 2 ? parseInt(h.substring(2)) : 0;
        // Create a UTC date for today to get proper DST offset
        const now = new Date();
        const utcDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), utcHour, utcMin));
        // Use the office timezone if available, fallback to America/Los_Angeles
        const tz = OFFICE_TIMEZONES[currentOffice] || 'America/Los_Angeles';
        try {
            const local = utcDate.toLocaleString('en-US', { hour: 'numeric', minute: utcMin > 0 ? '2-digit' : undefined, timeZone: tz, timeZoneName: 'short' });
            return local;
        } catch(e) {
            console.warn('Timezone conversion failed', e);
            // Fallback: use IANA zone to determine standard offset
            const stdOffsets = { 'America/New_York': -5, 'America/Chicago': -6, 'America/Denver': -7, 'America/Phoenix': -7, 'America/Los_Angeles': -8 };
            const offset = stdOffsets[tz] || -8;
            let localHr = (utcHour + offset + 24) % 24;
            const ampm = localHr >= 12 ? 'PM' : 'AM';
            const hr12 = localHr === 0 ? 12 : localHr > 12 ? localHr - 12 : localHr;
            return `${hr12} ${ampm}`;
        }
    });

    // Clean up geopotential heights: "541 dam" → "a 541-dam"
    t = t.replace(/(\d{3})\s*dam\b/g, '$1-decameter');

    // Clean up pressure level references
    t = t.replace(/(\d{3,4})\s*mb\b/g, '$1 mb level');

    // Convert long ALL CAPS stretches (5+ chars) to sentence case (skip known terms)
    t = t.replace(/\b([A-Z]{5,})\b/g, (m) => {
        if (GLOSSARY[m]) return m;
        return m.charAt(0) + m.slice(1).toLowerCase();
    });

    // "ern" catch-all removed — too aggressive, collides with English words

    // Clean up artifacts from stripped content
    t = t.replace(/\.\s*\.\s*/g, '. ');       // ". ." → "."
    t = t.replace(/\s{2,}/g, ' ');
    t = t.replace(/^\.\s*/gm, '');
    t = t.replace(/\bCA\.\s*/g, '');            // Strip state prefix "CA."
    t = t.replace(/\bPZ\.\s*/g, '');            // Strip marine zone prefix "PZ."
    t = t.trim();

    // ─── Bold pass: make key info skimmable ─────────────────────────
    // Helper: bold only first occurrence of each match
    const boldSeen = new Set();
    const boldFirst = (str, pattern) => {
        return str.replace(pattern, (m) => {
            const k = m.toLowerCase().trim();
            if (boldSeen.has(k)) return m;
            boldSeen.add(k);
            return `<strong>${m}</strong>`;
        });
    };

    // Days of week — first occurrence only
    t = boldFirst(t, /\b(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b/g);
    // Timeframes — first occurrence only
    t = boldFirst(t, /\b(tonight|this morning|this afternoon|this evening|overnight|today)\b/gi);

    // Temperatures
    t = t.replace(/(\d{1,3})\s*(?:degrees?|°)\s*(?:F|fahrenheit)?/gi, '<strong>$1°</strong>');
    // Wind speeds
    t = t.replace(/\b(\d{1,3})\s*(?:mph)\b/gi, '<strong>$1 mph</strong>');

    // Rainfall/snow ranges: "4 to 8 inches", "1-2.5 inches" (not ft — skip ceiling heights)
    t = t.replace(/\b(\d+(?:\.\d+)?)\s*(?:to|-)\s*(\d+(?:\.\d+)?)\s*(inches?|")\b/gi,
        (_, a, b) => `<strong>${a}–${b}"</strong>`);
    // Single number + inches
    t = t.replace(/\b(\d+(?:\.\d+)?)\s*(inches?|")\b/gi, '<strong>$1"</strong>');
    // Worded amounts
    t = t.replace(/\b((?:a\s+)?half(?:\s+and\s+one)?\s+inch(?:\s+per\s+hour)?)\b/gi, '<strong>$1</strong>');

    // Hazard terms — first occurrence only
    t = boldFirst(t, /\b(severe thunderstorms?|flash flood(?:ing)?|debris flows?|damaging winds?|heavy (?:mountain )?snow|high surf|coastal flood(?:ing)?)\b/gi);
    // Alert types — first occurrence only
    t = boldFirst(t, /\b(small craft advisory|gale warning|winter storm (?:watch|warning)|flood watch|wind advisory|high wind watch|high surf advisory|beach hazards? statement)\b/gi);

    // Clean up any double-bolded from overlapping matches
    t = t.replace(/<strong><strong>/g, '<strong>');
    t = t.replace(/<\/strong><\/strong>/g, '</strong>');

    // Split into blocks on double newlines
    const blocks = t.split(/\n\s*\n+/).filter(b => b.trim());

    let html = '';
    for (const block of blocks) {
        const trimmed = block.trim();
        // Check for sub-section header marker
        const subMatch = trimmed.match(/§§§\s*(.+?)\s*§§§\s*([\s\S]*)/);
        if (subMatch) {
            const title = subMatch[1].trim();
            const body = subMatch[2].trim();
            html += `<h4 class="sub-header">${title}</h4>`;
            if (body) html += `<p>${body}</p>`;
        } else if (!trimmed.match(/^§§§/)) {
            // Skip orphaned markers, render normal paragraphs
            html += `<p>${trimmed.replace(/\n/g, ' ')}</p>`;
        }
    }
    return html;
}

// ─── Annotated text with jargon highlights ──────────────────────────
function annotateText(text) {
    // Escape HTML
    let t = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

    // Sort glossary keys by length desc so longer matches first
    const keys = Object.keys(GLOSSARY).sort((a, b) => b.length - a.length);

    // Use placeholder tokens to prevent nested replacement
    const placeholders = [];
    let jargonId = 0;
    for (const key of keys) {
        const escaped = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`\\b${escaped}\\b`, 'g');
        t = t.replace(regex, (match) => {
            const idx = placeholders.length;
            const tipId = `jargon-tip-${jargonId++}`;
            const tipText = GLOSSARY[key].replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            placeholders.push(`<span class="jargon" tabindex="0" aria-describedby="${tipId}">${match}<span class="tip" role="tooltip" id="${tipId}">${tipText}</span></span>`);
            return `\x00JARGON${idx}\x00`;
        });
    }

    // Replace placeholders with actual HTML
    for (let i = 0; i < placeholders.length; i++) {
        t = t.replace(`\x00JARGON${i}\x00`, placeholders[i]);
    }

    return t;
}

// ─── Key Takeaway extraction ────────────────────────────────────────
function extractTakeaway(sections) {
    // Use synopsis, or first section
    const synSection = sections.find(s => s.key === 'Synopsis') || sections[0];
    if (!synSection) return '';
    // Take first 1-2 sentences
    const text = synSection.text.replace(/\.{2,}/g, '. ').replace(/\s+/g, ' ').trim();
    const sentences = text.match(/[^.!?]+[.!?]+/g);
    if (!sentences) return text.substring(0, 200);
    const takeaway = sentences.slice(0, 2).join(' ').trim();
    // Quick cleanup
    return translateToPlainEnglish(takeaway).replace(/<\/?p>/g, '');
}

// ─── Confidence indicator ────────────────────────────────────────────
function displayConfidence(fullText) {
    const container = document.getElementById('confidence-container');
    const bar = document.getElementById('confidence-bar');
    const text = document.getElementById('confidence-text');
    const t = fullText.toLowerCase();

    // Count uncertainty vs certainty language
    const uncertainWords = [
        'uncertain', 'uncertainty', 'low confidence', 'unclear', 'remain uncertain',
        'possible', 'possibly', 'could', 'might', 'may', 'perhaps',
        'slight chance', 'can\'t rule out', 'cannot rule out',
        'tricky', 'challenging', 'difficult', 'complicated',
        'spread', 'wide range', 'diverge', 'disagreement', 'inconsistent',
        'low predictability', 'questionable', 'iffy', 'depends on',
    ];
    const certainWords = [
        'high confidence', 'confident', 'certain', 'expected',
        'will', 'likely', 'probable', 'increasing confidence',
        'good agreement', 'consistent', 'consensus',
        'strong signal', 'well-defined', 'increasingly likely',
        'on track', 'remains on track',
    ];

    let uncertainCount = 0;
    let certainCount = 0;
    for (const w of uncertainWords) { const m = t.match(new RegExp(w, 'gi')); if (m) uncertainCount += m.length; }
    for (const w of certainWords) { const m = t.match(new RegExp(w, 'gi')); if (m) certainCount += m.length; }

    const total = uncertainCount + certainCount;
    if (total === 0) { container.style.display = 'none'; return; }

    // Score: 0 (all uncertain) to 100 (all certain)
    const score = Math.round((certainCount / total) * 100);

    // Map to label and color
    let label, color;
    if (score >= 75) { label = 'High'; color = '#16a34a'; }
    else if (score >= 50) { label = 'Moderate'; color = '#2563eb'; }
    else if (score >= 30) { label = 'Mixed'; color = '#d97706'; }
    else { label = 'Low'; color = '#dc2626'; }

    bar.style.width = `${score}%`;
    bar.style.background = color;
    text.textContent = label;
    text.style.color = color;
    container.style.display = '';
}

// ─── Format Active Alerts as a clean list ───────────────────────────
// Alert modal — data store keyed by index (avoids inline JSON / XSS)
const ALERT_DATA = {};
let alertIdx = 0;

function showAlertModal(data) {
    const overlay = document.getElementById('alert-modal-overlay');
    const modal = overlay.querySelector('.alert-modal');
    document.getElementById('alert-modal-title').textContent = data.headline;
    const meta = [];
    if (data.severity) meta.push(data.severity);
    if (data.areaDesc) meta.push(data.areaDesc);
    if (data.expires) {
        try { meta.push('Expires ' + new Date(data.expires).toLocaleString()); } catch(e) { console.warn('Date parse error', e); }
    }
    document.getElementById('alert-modal-meta').textContent = meta.join(' · ');
    let body = data.description || '';
    if (data.instruction) body += '\n\n' + data.instruction;
    document.getElementById('alert-modal-body').textContent = body;
    overlay.classList.add('open');
    // Focus trap: move focus into modal
    document.getElementById('alert-modal-close').focus();
}

function closeAlertModal() {
    document.getElementById('alert-modal-overlay').classList.remove('open');
}

document.addEventListener('DOMContentLoaded', () => {
    const overlay = document.getElementById('alert-modal-overlay');
    if (!overlay) return;
    document.getElementById('alert-modal-close').addEventListener('click', closeAlertModal);
    overlay.addEventListener('click', (e) => { if (e.target === overlay) closeAlertModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAlertModal(); });

    // Focus trap within modal
    overlay.addEventListener('keydown', (e) => {
        if (e.key !== 'Tab') return;
        const focusable = overlay.querySelectorAll('button, [href], [tabindex]:not([tabindex="-1"])');
        if (focusable.length === 0) return;
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
        else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
    });

    // Event delegation for alert links (avoids inline onclick / XSS)
    document.addEventListener('click', (e) => {
        const link = e.target.closest('[data-alert-idx]');
        if (link) showAlertModal(ALERT_DATA[link.dataset.alertIdx]);
    });

    // Jargon tooltip tap-to-toggle for mobile
    document.addEventListener('click', (e) => {
        const jargon = e.target.closest('.jargon');
        // Close all other open tooltips
        document.querySelectorAll('.jargon.tip-open').forEach(el => {
            if (el !== jargon) el.classList.remove('tip-open');
        });
        if (jargon) jargon.classList.toggle('tip-open');
    });
});

function formatAlerts(text, alertMap) {
    // Split on alert types and format as list items
    let t = text;
    // Strip zone codes, product codes, state/marine prefixes
    t = t.replace(/for\s+zones?\s+[\d\->]+/gi, '');
    t = t.replace(/\(See\s+[A-Za-z]+\)/gi, '');
    t = t.replace(/\(\s*\)/g, '');
    t = t.replace(/\bCA\s*\.{1,3}\s*/g, '');
    t = t.replace(/\bPZ\s*\.{1,3}\s*/g, '');
    t = t.replace(/\b(?:Lax|Cfw|Srf|Npw|Mww|Wsw|Ffa)[a-z]{2,8}\b\.?/gi, '');
    t = t.replace(/\.\s*\.\s*/g, '. ');
    t = t.replace(/\s{2,}/g, ' ').trim();

    // Split on known alert types to create individual items
    const alertPattern = /((?:High Wind Watch|Wind Advisory|Flood Watch|High Surf Advisory|Beach Hazards? Statement|Winter Storm (?:Watch|Warning)|Small Craft Advisory|Gale Warning|Storm Warning|Red Flag Warning|Fire Weather Watch|Tornado Watch|Tornado Warning|Severe Thunderstorm (?:Watch|Warning)|Flash Flood Warning|Blizzard Warning|Ice Storm Warning|Freeze Warning|Frost Advisory|Dense Fog Advisory|Heat Advisory|Excessive Heat Warning)[^.]*\.?)/gi;

    const matches = t.match(alertPattern);
    if (!matches || matches.length === 0) {
        return `<p>${t}</p>`;
    }

    const items = matches.map(m => {
        let item = m.trim().replace(/\.\s*$/, '').replace(/^\.\s*/, '').trim();
        item = item.charAt(0).toUpperCase() + item.slice(1);
        // Classify by severity
        let cls = 'alert-advisory';
        if (/warning/i.test(item)) cls = 'alert-warning';
        else if (/watch/i.test(item)) cls = 'alert-watch';
        else if (/statement/i.test(item)) cls = 'alert-statement';
        // Severity icon for accessibility (not color-only)
        const icon = /warning/i.test(item) ? '⚠️ ' : /watch/i.test(item) ? '👁️ ' : /statement/i.test(item) ? 'ℹ️ ' : '🔹 ';
        // Try to find matching alert detail
        let alertData = null;
        if (alertMap) {
            for (const [event, data] of Object.entries(alertMap)) {
                if (item.toLowerCase().includes(event.toLowerCase())) { alertData = data; break; }
            }
        }
        let content;
        if (alertData) {
            const idx = alertIdx++;
            ALERT_DATA[idx] = alertData;
            content = `<button class="alert-link" data-alert-idx="${idx}" aria-label="View details: ${item.replace(/"/g, '&quot;')}">${icon}${item}</button>`;
        } else {
            content = `${icon}${item}`;
        }
        return `<li class="${cls}">${content}</li>`;
    });

    return `<ul class="alert-list">${items.join('')}</ul>`;
}

// ─── AI Translation ─────────────────────────────────────────────────
let aiMode = false;
const aiCache = {}; // client-side cache keyed by text hash

function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0;
    }
    return hash.toString(36);
}

async function fetchAITranslation(text, section, office) {
    const key = simpleHash(text);
    if (aiCache[key]) return aiCache[key];

    const res = await fetch('/api/translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, section, office })
    });
    if (!res.ok) throw new Error('Translation failed');
    const data = await res.json();
    // Convert markdown bold to HTML
    let html = data.translation
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .split(/\n\s*\n+/)
        .filter(b => b.trim())
        .map(b => `<p>${b.trim().replace(/\n/g, ' ')}</p>`)
        .join('');
    aiCache[key] = html;
    return html;
}

async function translateSectionAI(sectionEl, text, sectionName) {
    const plainCol = sectionEl.querySelector('.plain-col');
    if (!plainCol) return;
    // Show loading
    const original = plainCol.innerHTML;
    plainCol.dataset.regexHtml = original;
    plainCol.innerHTML = '<div style="display:flex;align-items:center;gap:0.5rem;color:var(--text-light);font-family:var(--sans);font-size:0.85rem"><span class="ai-loading"></span> Translating with AI...</div>';
    try {
        const html = await fetchAITranslation(text, sectionName, currentOffice);
        plainCol.innerHTML = `<div class="ai-translated">${html}</div>`;
    } catch (e) {
        console.warn('AI translation failed for', sectionName, e);
        plainCol.innerHTML = original;
    }
}

function revertSectionToRegex(sectionEl) {
    const plainCol = sectionEl.querySelector('.plain-col');
    if (plainCol && plainCol.dataset.regexHtml) {
        plainCol.innerHTML = plainCol.dataset.regexHtml;
    }
}

let currentSections = []; // store for re-translation

// ─── Render ─────────────────────────────────────────────────────────
function render(sections) {
    const sectionsEl = document.getElementById('sections');
    const navEl = document.getElementById('section-nav');
    const takeawayContainer = document.getElementById('takeaway-container');
    const takeawayText = document.getElementById('takeaway-text');

    // Key takeaway
    const takeaway = extractTakeaway(sections);
    if (takeaway) {
        takeawayText.innerHTML = takeaway;
        takeawayContainer.style.display = '';
    }

    // Section nav — sanitize IDs for URL safety
    const safeId = (key) => key.replace(/[^a-zA-Z0-9]+/g, '-').replace(/^-|-$/g, '').toLowerCase();
    navEl.innerHTML = sections.map(s =>
        `<a href="#section-${safeId(s.key)}" aria-label="Jump to ${s.key} section">${s.key}</a>`
    ).join('');

    // Store sections for AI translation
    currentSections = sections;

    // Render sections with regex first (instant), then upgrade with AI
    sectionsEl.innerHTML = sections.map(s => {
        let plainHtml;
        if (s.key === 'Active Alerts') {
            plainHtml = formatAlerts(s.text, currentAlerts);
        } else {
            // Show loading spinner initially
            plainHtml = '<div style="display:flex;align-items:center;gap:0.5rem;color:var(--text-light);font-family:var(--sans);font-size:0.85rem"><span class="ai-loading"></span> Summarizing...</div>';
        }
        return `
        <div class="forecast-section" id="section-${safeId(s.key)}" data-section-key="${s.key}">
            <div class="section-title">${s.key}</div>
            <div class="columns">
                <div>
                    <div class="col-label">Summary · Powered by <a href="https://www.anthropic.com/claude/haiku" target="_blank" rel="noopener noreferrer" style="color:inherit;text-decoration:underline;text-decoration-color:var(--border)">Claude</a></div>
                    <div class="plain-col">${plainHtml}</div>
                </div>
                <div>
                    <div class="col-label">Original + Annotations</div>
                    <div class="annotated-col">${annotateText(s.text)}</div>
                </div>
            </div>
        </div>`;
    }).join('');

    // Fire off AI translations for all non-alert sections
    for (const s of sections) {
        if (s.key === 'Active Alerts') continue;
        const el = document.getElementById(`section-${safeId(s.key)}`);
        if (!el) continue;
        const plainCol = el.querySelector('.plain-col');
        fetchAITranslation(s.text, s.key, currentOffice).then(html => {
            plainCol.innerHTML = html;
        }).catch(err => {
            console.warn('AI translation failed for', s.key, err);
            // Fall back to regex
            plainCol.innerHTML = translateToPlainEnglish(s.text);
        });
    }
}

// ─── Fetch AFD ──────────────────────────────────────────────────────
async function fetchAFD(office) {
    currentOffice = office;
    const thisGen = ++fetchGeneration;
    const sectionsEl = document.getElementById('sections');
    sectionsEl.innerHTML = '<div class="loading">Loading forecast…</div>';
    // Reset alert index for new fetch
    alertIdx = 0;

    // Update footer office name
    const footerOffice = document.getElementById('footer-office');
    if (footerOffice) footerOffice.textContent = office;

    // Check cache first (15 min TTL)
    const cached = sessionStorage.getItem(`afd-${office}`);
    if (cached) {
        try {
            const { time, prodData } = JSON.parse(cached);
            if (Date.now() - time < 15 * 60 * 1000) {
                if (thisGen === fetchGeneration) renderAFD(prodData, office);
                return;
            }
        } catch(e) { console.warn('Cache parse error, refetching', e); }
    }

    try {
        const listRes = await fetch(`https://api.weather.gov/products/types/AFD/locations/${office}`, {
            headers: { 'User-Agent': 'Plaincast/1.0 (plaincast.live)' }
        });
        if (!listRes.ok) throw new Error(`API error: ${listRes.status} ${listRes.statusText}`);
        if (thisGen !== fetchGeneration) return; // stale request
        const listData = await listRes.json();
        const latest = listData['@graph']?.[0];
        if (!latest) throw new Error('No AFD found for this office');

        const prodUrl = latest['@id'] || `https://api.weather.gov/products/${latest.id}`;
        const prodRes = await fetch(prodUrl, {
            headers: { 'User-Agent': 'Plaincast/1.0 (plaincast.live)' }
        });
        if (!prodRes.ok) throw new Error(`Product fetch error: ${prodRes.status}`);
        if (thisGen !== fetchGeneration) return; // stale request
        const prodData = await prodRes.json();

        // Cache the result
        sessionStorage.setItem(`afd-${office}`, JSON.stringify({
            time: Date.now(),
            prodData
        }));

        if (thisGen === fetchGeneration) renderAFD(prodData, office);

    } catch (err) {
        if (thisGen !== fetchGeneration) return;
        // Try stale cache as fallback
        if (cached) {
            try {
                const { prodData } = JSON.parse(cached);
                renderAFD(prodData, office);
                return;
            } catch(e) { console.warn('Stale cache fallback failed', e); }
        }
        sectionsEl.innerHTML = `<div class="loading">Error loading forecast: ${err.message}</div>`;
        console.error(err);
    }
}

async function renderAFD(prodData, office) {
    const sectionsEl = document.getElementById('sections');

    // Update raw link
    const rawUrl = prodData['@id'] || `https://api.weather.gov/products/${prodData.id}`;
    document.getElementById('raw-link').href = rawUrl;

    // Parse issue time with office timezone
    const tz = OFFICE_TIMEZONES[office] || 'America/Los_Angeles';
    const issueTime = new Date(prodData.issuanceTime);
    const now = new Date();
    const diffMs = now - issueTime;
    const diffHours = Math.round(diffMs / 3600000);
    const diffMins = Math.round(diffMs / 60000);
    let ago = '';
    if (diffMins < 60) ago = `${diffMins} minutes ago`;
    else if (diffHours < 24) ago = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    else ago = `${Math.round(diffHours / 24)} day${Math.round(diffHours/24) !== 1 ? 's' : ''} ago`;

    issueTimeDate = issueTime;
    document.getElementById('issue-time').textContent =
        `Issued ${issueTime.toLocaleString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', timeZone: tz, timeZoneName: 'short' })} - ${ago}`;

    // Parse sections
    const { sections } = parseSections(prodData.productText);
    if (sections.length === 0) {
        sectionsEl.innerHTML = '<div class="loading">Could not parse forecast sections.</div>';
        return;
    }

    // Extract and display confidence
    displayConfidence(prodData.productText);

    // Fetch live alerts for linking (non-blocking — render first, update after)
    currentAlerts = {};
    render(sections);

    // Then fetch alerts and re-render the alerts section with links
    fetchAlerts(office).then(alertMap => {
        currentAlerts = alertMap;
        // Re-render just the alerts section if we got links
        if (Object.keys(alertMap).length > 0) {
            const alertSection = sections.find(s => s.key === 'Active Alerts');
            if (alertSection) {
                const el = document.getElementById('section-active-alerts');
                if (el) {
                    const plainCol = el.querySelector('.plain-col');
                    if (plainCol) plainCol.innerHTML = formatAlerts(alertSection.text, alertMap);
                }
            }
        }
    });
}

// ─── Init ───────────────────────────────────────────────────────────
const officeSelect = document.getElementById('office-select');
officeSelect.addEventListener('change', () => fetchAFD(officeSelect.value));
fetchAFD(officeSelect.value);

// Auto-update "X minutes ago" every 60 seconds
setInterval(() => {
    if (!issueTimeDate) return;
    const now = new Date();
    const diffMs = now - issueTimeDate;
    const diffMins = Math.round(diffMs / 60000);
    const diffHours = Math.round(diffMs / 3600000);
    let ago = '';
    if (diffMins < 60) ago = `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    else if (diffHours < 24) ago = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    else ago = `${Math.round(diffHours / 24)} day${Math.round(diffHours/24) !== 1 ? 's' : ''} ago`;
    const el = document.getElementById('issue-time');
    if (el) el.textContent = el.textContent.replace(/ - \d+.*$/, ` - ${ago}`);
}, 60000);
</script>

<!-- Alert detail modal -->
<div class="alert-modal-overlay" id="alert-modal-overlay">
    <div class="alert-modal" role="dialog" aria-modal="true" aria-labelledby="alert-modal-title">
        <button class="alert-modal-close" id="alert-modal-close" aria-label="Close alert detail">&times;</button>
        <h3 id="alert-modal-title"></h3>
        <div class="alert-meta" id="alert-modal-meta"></div>
        <div class="alert-body" id="alert-modal-body"></div>
    </div>
</div>
</body>
</html>
