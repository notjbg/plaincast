<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plaincast — NWS Forecasts, Decoded</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --text: #1c1917;
            --text-light: #78716c;
            --blue: #2563eb;
            --blue-light: #eff6ff;
            --border: #e7e5e4;
            --bg: #ffffff;
            --serif: Georgia, 'Times New Roman', serif;
            --mono: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            --sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            font-family: var(--serif);
            font-size: 17px;
            line-height: 1.7;
            color: var(--text);
            background: var(--bg);
        }

        /* Header */
        .header {
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 2rem 1rem;
        }
        .header h1 {
            font-family: var(--serif);
            font-size: 2rem;
            font-weight: 400;
            letter-spacing: -0.02em;
        }
        .header-row {
            display: flex;
            align-items: baseline;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .header select {
            font-family: var(--sans);
            font-size: 0.85rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.3rem 0.5rem;
            background: var(--bg);
            color: var(--text);
        }
        .issue-time {
            font-family: var(--sans);
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        .explainer {
            margin-top: 0.75rem;
            max-width: 680px;
        }
        .explainer summary {
            font-family: var(--sans);
            font-size: 0.8rem;
            color: var(--text-light);
            cursor: pointer;
            letter-spacing: 0.02em;
            list-style: none;
        }
        .explainer summary::-webkit-details-marker { display: none; }
        .explainer summary::before {
            content: '+ ';
            font-weight: 600;
        }
        .explainer[open] summary::before {
            content: '− ';
        }
        .explainer p {
            font-family: var(--sans);
            font-size: 0.85rem;
            line-height: 1.65;
            color: var(--text-light);
            margin-top: 0.5rem;
            font-style: italic;
        }

        /* Key Takeaway */
        .takeaway {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem 1.5rem;
        }
        .takeaway-box {
            background: var(--blue-light);
            border-left: 3px solid var(--blue);
            padding: 1.25rem 1.5rem;
            border-radius: 0 6px 6px 0;
        }
        .takeaway-label {
            font-family: var(--sans);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--blue);
            margin-bottom: 0.35rem;
        }
        .takeaway-text {
            font-size: 1.15rem;
            line-height: 1.6;
        }

        /* Confidence indicator */
        .confidence {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem 1rem;
        }
        .confidence-box {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
        }
        .confidence-label {
            font-family: var(--sans);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-light);
            white-space: nowrap;
        }
        .confidence-bar-wrap {
            flex: 1;
            max-width: 200px;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .confidence-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .confidence-text {
            font-family: var(--sans);
            font-size: 0.8rem;
            color: var(--text);
            font-weight: 500;
        }

        /* Section nav */
        .section-nav {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem 1.5rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .section-nav a {
            font-family: var(--sans);
            font-size: 0.8rem;
            color: var(--text-light);
            text-decoration: none;
            padding: 0.25rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 999px;
            transition: all 0.15s;
        }
        .section-nav a:hover {
            color: var(--text);
            border-color: var(--text-light);
        }

        /* Sections */
        .sections {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem 4rem;
        }
        .forecast-section {
            margin-bottom: 3rem;
        }
        .section-title {
            font-family: var(--sans);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-light);
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1.25rem;
        }
        .columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2.5rem;
        }
        @media (max-width: 768px) {
            .columns { grid-template-columns: 1fr; gap: 1.5rem; }
            .header, .takeaway, .section-nav, .sections { padding-left: 1.25rem; padding-right: 1.25rem; }
            .header h1 { font-size: 1.5rem; }
        }

        .col-label {
            font-family: var(--sans);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-light);
            margin-bottom: 0.75rem;
        }

        /* Plain English column */
        .plain-col p {
            margin-bottom: 1rem;
        }
        .plain-col .sub-header {
            font-family: var(--sans);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            margin: 1.5rem 0 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--border);
        }
        .plain-col .sub-header:first-child {
            margin-top: 0;
        }
        .plain-col .alert-list {
            list-style: none;
            padding: 0;
        }
        .plain-col .alert-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.95rem;
        }
        .plain-col .alert-list li:last-child {
            border-bottom: none;
        }

        /* Annotated column */
        .annotated-col {
            font-family: var(--mono);
            font-size: 0.82rem;
            line-height: 1.65;
            color: #44403c;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Jargon highlights */
        .jargon {
            background: #fef9c3;
            border-bottom: 1px dashed #ca8a04;
            cursor: help;
            padding: 0 2px;
            border-radius: 2px;
            position: relative;
        }
        .jargon:hover { background: #fef08a; }
        .jargon .tip {
            display: none;
            position: absolute;
            bottom: calc(100% + 6px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--text);
            color: #fff;
            font-family: var(--sans);
            font-size: 0.78rem;
            line-height: 1.4;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            width: max-content;
            max-width: 280px;
            z-index: 100;
            white-space: normal;
            font-weight: 400;
        }
        .jargon:hover .tip { display: block; }

        /* Loading / error */
        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
            font-family: var(--sans);
            font-size: 0.95rem;
        }

        /* Footer */
        .footer {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            border-top: 1px solid var(--border);
            font-family: var(--sans);
            font-size: 0.8rem;
            color: var(--text-light);
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .footer a { color: var(--text-light); }
    </style>
</head>
<body>

<div class="header">
    <div class="header-row">
        <h1>Plaincast</h1>
        <select id="office-select">
            <option value="LOX">Los Angeles / Oxnard (LOX)</option>
            <option value="SGX">San Diego (SGX)</option>
            <option value="HNX">Hanford (HNX)</option>
            <option value="VEF">Las Vegas (VEF)</option>
            <option value="MTR">San Francisco (MTR)</option>
            <option value="SEW">Seattle (SEW)</option>
            <option value="PQR">Portland (PQR)</option>
            <option value="OKX">New York (OKX)</option>
        </select>
    </div>
    <div class="issue-time" id="issue-time"></div>
    <details class="explainer">
        <summary>What is this?</summary>
        <p>Area Forecast Discussions are the real forecasts — written 3–4 times daily by NWS meteorologists reading the models and interpreting what they mean for your area. They offer far deeper insight than any weather app, but they're written in dense meteorological shorthand. Plaincast translates them into plain English, side by side with the original.</p>
    </details>
</div>

<div class="takeaway" id="takeaway-container" style="display:none">
    <div class="takeaway-box">
        <div class="takeaway-label">Key Takeaway</div>
        <div class="takeaway-text" id="takeaway-text"></div>
    </div>
</div>

<div class="confidence" id="confidence-container" style="display:none">
    <div class="confidence-box">
        <div class="confidence-label">Forecaster Confidence</div>
        <div class="confidence-bar-wrap">
            <div class="confidence-bar" id="confidence-bar"></div>
        </div>
        <div class="confidence-text" id="confidence-text"></div>
    </div>
</div>

<nav class="section-nav" id="section-nav"></nav>

<div class="sections" id="sections">
    <div class="loading" id="loading">Loading forecast…</div>
</div>

<div class="footer">
    <span>Data: <a href="https://www.weather.gov" target="_blank" rel="noopener noreferrer">NWS <span id="footer-office">LOX</span></a></span>
    <a href="" id="raw-link" target="_blank" rel="noopener noreferrer">View raw AFD</a>
    <span style="margin-left:auto">Built by <a href="https://jonahberg.com" target="_blank" rel="noopener noreferrer">Jonah Berg</a></span>
</div>

<script>
// ─── Jargon Glossary ───────────────────────────────────────────────
const GLOSSARY = {
    // Pressure levels & heights
    'dam': 'Decameters — unit for geopotential height on upper-air charts',
    '500mb': '500 millibars — roughly 18,000 ft; a key level for steering weather systems',
    '500 mb': '500 millibars — roughly 18,000 ft; a key level for steering weather systems',
    '300mb': '300 millibars — roughly 30,000 ft; jet stream level',
    '300 mb': '300 millibars — roughly 30,000 ft; jet stream level',
    '700mb': '700 millibars — roughly 10,000 ft; used for moisture analysis',
    '700 mb': '700 millibars — roughly 10,000 ft; used for moisture analysis',
    '850mb': '850 millibars — roughly 5,000 ft; low-level temperature/moisture',
    '850 mb': '850 millibars — roughly 5,000 ft; low-level temperature/moisture',
    '250mb': '250 millibars — roughly 34,000 ft; upper jet stream',
    '250 mb': '250 millibars — roughly 34,000 ft; upper jet stream',
    '200mb': '200 millibars — roughly 39,000 ft; top of troposphere',
    '925mb': '925 millibars — roughly 2,500 ft; near-surface analysis',

    // Precipitation & moisture
    'PWAT': 'Precipitable Water — total water vapor in a column of atmosphere',
    'PWATs': 'Precipitable Water values',
    'QPF': 'Quantitative Precipitation Forecast — predicted rainfall amounts',
    'PoP': 'Probability of Precipitation',
    'POPS': 'Probability of Precipitation',
    'IVT': 'Integrated Vapor Transport — measure of atmospheric river strength',

    // Instability & convection
    'CAPE': 'Convective Available Potential Energy — fuel for thunderstorms',
    'CIN': 'Convective Inhibition — a cap that suppresses thunderstorms',
    'LI': 'Lifted Index — stability measure; negative = more unstable',
    'TSTM': 'Thunderstorm',
    'TSTMS': 'Thunderstorms',
    'tstm': 'Thunderstorm',
    'tstms': 'Thunderstorms',
    'convection': 'Rising air producing clouds/storms, often meaning thunderstorms',
    'convective': 'Related to rising air and thunderstorm development',
    'MCS': 'Mesoscale Convective System — large organized thunderstorm complex',
    'supercell': 'A severe rotating thunderstorm',
    'mesocyclone': 'A rotating updraft within a supercell thunderstorm',

    // Dynamics & synoptic
    'vort': 'Vorticity — spin in the atmosphere; positive vort = rising motion',
    'vort lobe': 'A concentrated area of atmospheric spin that can trigger storms',
    'PVA': 'Positive Vorticity Advection — spin moving in, often triggers rising air',
    'NVA': 'Negative Vorticity Advection — spin moving out, often triggers sinking air',
    'trof': 'Trough — an elongated area of low pressure',
    'trough': 'An elongated area of low pressure bringing unsettled weather',
    'ridge': 'An elongated area of high pressure bringing fair weather',
    'ridging': 'Building high pressure',
    'zonal': 'West-to-east flow pattern — generally less active weather',
    'meridional': 'North-south flow pattern — more active, extreme weather',
    'shortwave': 'A small-scale trough moving through the larger flow pattern',
    'longwave': 'A large-scale trough or ridge spanning thousands of miles',
    'jet': 'Jet stream — fast-moving river of air at 30,000+ ft',
    'jet streak': 'An area of maximum winds within the jet stream',
    'upper-level': 'High in the atmosphere, typically 18,000 ft and above',
    'low-level': 'Near the surface, below about 10,000 ft',
    'subtropical jet': 'A jet stream near 25-30°N latitude',
    'polar jet': 'A jet stream near 40-60°N latitude',
    'diffluence': 'Air spreading apart aloft — supports rising motion',
    'confluence': 'Air coming together aloft — supports sinking motion',
    'divergence': 'Air spreading out — at the surface causes low pressure',
    'convergence': 'Air coming together — at the surface causes rising motion',
    'omega': 'Vertical motion in the atmosphere (omega equation)',
    'WAA': 'Warm Air Advection — warm air moving in',
    'CAA': 'Cold Air Advection — cold air moving in',

    // Fronts & boundaries
    'OFB': 'Outflow Boundary — a gust front from a thunderstorm',
    'FROPA': 'Frontal Passage — a front moving through the area',
    'frontal passage': 'A weather front moving through, bringing wind/temperature changes',
    'cold front': 'Leading edge of advancing cold air',
    'warm front': 'Leading edge of advancing warm air',
    'occluded front': 'Where a cold front has caught up to a warm front',
    'stationary front': 'A front that is not moving',
    'dryline': 'Boundary between moist and dry air; can trigger storms',
    'SFC': 'Surface',
    'sfc': 'Surface',

    // Aviation
    'MVFR': 'Marginal VFR — ceiling 1,000–3,000 ft or visibility 3–5 miles',
    'IFR': 'Instrument Flight Rules — ceiling 500–1,000 ft or visibility 1–3 miles',
    'LIFR': 'Low IFR — ceiling below 500 ft or visibility below 1 mile',
    'VFR': 'Visual Flight Rules — ceiling above 3,000 ft and visibility above 5 miles',
    'TAF': 'Terminal Aerodrome Forecast — airport-specific weather forecast',
    'GDP': 'Ground Delay Program — FAA program delaying flights to a destination',
    'GS': 'Ground Stop — all flights to an airport halted temporarily',
    'METAR': 'Routine aviation weather observation report',
    'SPECI': 'Special (unscheduled) aviation weather observation',
    'SIGMET': 'Significant Meteorological Information — advisory for severe weather',
    'AIRMET': 'Airmen\'s Meteorological Information — advisory for moderate weather',
    'PIREP': 'Pilot Report of actual flight conditions',
    'CIG': 'Ceiling — height of the lowest broken/overcast cloud layer',
    'cig': 'Ceiling — height of the lowest broken/overcast cloud layer',
    'CIGS': 'Ceilings',
    'cigs': 'Ceilings',
    'VSBY': 'Visibility',
    'vsby': 'Visibility',
    'TURB': 'Turbulence',

    // Sky conditions
    'BKN': 'Broken — 5/8 to 7/8 cloud cover',
    'OVC': 'Overcast — 8/8 cloud cover (complete)',
    'SCT': 'Scattered — 3/8 to 4/8 cloud cover',
    'FEW': 'Few — 1/8 to 2/8 cloud cover',
    'CLR': 'Clear — no clouds',
    'SKC': 'Sky Clear',

    // Heights
    'AGL': 'Above Ground Level',
    'MSL': 'Mean Sea Level',
    'FL': 'Flight Level — altitude in hundreds of feet based on standard pressure',

    // Airport codes
    'KLAX': 'Los Angeles International Airport',
    'KBUR': 'Burbank Airport',
    'KSNA': 'John Wayne / Orange County Airport',
    'KVNY': 'Van Nuys Airport',
    'KSMO': 'Santa Monica Airport',
    'KONT': 'Ontario International Airport',
    'KSBA': 'Santa Barbara Airport',
    'KOXR': 'Oxnard / Ventura County Airport',
    'KLGB': 'Long Beach Airport',
    'KPSP': 'Palm Springs Airport',
    'KSAN': 'San Diego International Airport',
    'KSFO': 'San Francisco International Airport',
    'KJFK': 'John F. Kennedy International Airport',
    'KSEA': 'Seattle-Tacoma International Airport',

    // Marine
    'SCA': 'Small Craft Advisory — hazardous conditions for small boats',
    'GALE': 'Gale Warning — sustained winds 34–47 knots',
    'gale warning': 'Sustained winds 34–47 knots on the water',
    'storm warning': 'Sustained winds 48–63 knots on the water',
    'hurricane force': 'Sustained winds 64+ knots on the water',
    'seas': 'Combined wave height (wind waves + swell)',
    'swell': 'Waves generated by distant weather systems',
    'wind waves': 'Waves generated by local winds',
    'chop': 'Short, steep wind waves',
    'KTS': 'Knots — nautical miles per hour',
    'kts': 'Knots — nautical miles per hour',
    'kt': 'Knot — one nautical mile per hour',
    'NM': 'Nautical Miles',

    // Abbreviations (general)
    'chc': 'Chance',
    'csts': 'Coasts',
    'vlys': 'Valleys',
    'mtns': 'Mountains',
    'wnds': 'Winds',
    'temps': 'Temperatures',
    'temp': 'Temperature',
    'pcpn': 'Precipitation',
    'precip': 'Precipitation',
    'max': 'Maximum',
    'min': 'Minimum',
    'aftn': 'Afternoon',
    'mrng': 'Morning',
    'eve': 'Evening',
    'erly': 'Early',
    'thru': 'Through',
    'btwn': 'Between',
    'isol': 'Isolated',
    'sct': 'Scattered',
    'num': 'Numerous',
    'ocnl': 'Occasional',
    'intmt': 'Intermittent',
    'cont': 'Continue/continuing',
    'incr': 'Increase/increasing',
    'decr': 'Decrease/decreasing',
    'devel': 'Develop/developing',
    'dvlpg': 'Developing',
    'wrn': 'Western',
    'ern': 'Eastern',
    'nrn': 'Northern',
    'srn': 'Southern',
    'cntrl': 'Central',
    'fcst': 'Forecast',
    'NBM': 'National Blend of Models — a consensus forecast model',
    'GFS': 'Global Forecast System — American global weather model',
    'ECMWF': 'European Centre model — often considered most accurate global model',
    'NAM': 'North American Mesoscale — regional weather model',
    'HRRR': 'High-Resolution Rapid Refresh — hourly updated short-range model',
    'RAP': 'Rapid Refresh — hourly updated model',
    'HREF': 'High-Resolution Ensemble Forecast',
    'ensembles': 'Multiple model runs showing range of possible outcomes',
    'ensemble': 'Multiple model runs showing range of possible outcomes',
    'hi res': 'High resolution models — more detailed, shorter range',
    'deterministic': 'A single model run (vs ensemble of many runs)',
    'climo': 'Climatology — historical average conditions',
    'climatological': 'Based on historical weather averages for the location/date',
    'anom': 'Anomaly — departure from the historical average',
    'above normal': 'Higher than the historical average for the date',
    'below normal': 'Lower than the historical average for the date',
    'near normal': 'Close to the historical average for the date',

    // Time references
    'Z': 'Zulu time (UTC) — subtract 8 hours for PST, 7 for PDT',
    'UTC': 'Coordinated Universal Time — the global time standard',
    '00Z': 'Midnight UTC (4 PM PST / 5 PM PDT)',
    '06Z': '6 AM UTC (10 PM PST / 11 PM PDT)',
    '12Z': 'Noon UTC (4 AM PST / 5 AM PDT)',
    '18Z': '6 PM UTC (10 AM PST / 11 AM PDT)',

    // Wind & pressure
    'SLP': 'Sea Level Pressure',
    'mb': 'Millibars — unit of atmospheric pressure',
    'hPa': 'Hectopascals — same as millibars',
    'gusts': 'Brief, sudden increases in wind speed',

    // Phenomena
    'AR': 'Atmospheric River — a plume of tropical moisture',
    'atmospheric river': 'A plume of tropical moisture bringing heavy rain',
    'Pineapple Express': 'Atmospheric river originating near Hawaii',
    'Santa Ana': 'Hot, dry offshore winds in Southern California',
    'Diablo winds': 'Hot, dry offshore winds in the San Francisco Bay Area',
    'Sundowner': 'Hot, dry downslope winds on the south coast of Santa Barbara',
    'marine layer': 'Cool, moist air from the ocean, often bringing low clouds/fog',
    'onshore flow': 'Wind blowing from the ocean toward land — cooler, moister',
    'offshore flow': 'Wind blowing from land toward the ocean — warmer, drier',
    'subsidence': 'Sinking air in the atmosphere — brings clearing and warming',
    'inversion': 'Temperature increasing with height, trapping cool/polluted air below',
    'lee trough': 'Low pressure area forming downwind of mountains',
    'Catalina Eddy': 'A counter-clockwise circulation off the SoCal coast bringing clouds',
    'eddy': 'A circulation pattern, often bringing clouds to coastal areas',
    'upslope': 'Air moving up a mountain slope — can trigger clouds/precip',
    'downslope': 'Air moving down a mountain slope — warming and drying',
    'orographic': 'Weather effects caused by mountains (lifting, blocking, etc.)',
    'lapse rate': 'Rate of temperature decrease with altitude — steeper = more unstable',
    'NEXRAD': 'Next-Generation Radar — the NWS Doppler radar network',
    'RH': 'Relative Humidity',
    'dewpoint': 'Temperature at which air becomes saturated — higher = more humid',
    'mixing ratio': 'Amount of water vapor in the air by weight',
    'theta-e': 'Equivalent potential temperature — combines temperature and moisture',
    'snow level': 'Altitude where precipitation changes from rain to snow',
    'freezing level': 'Altitude where temperature reaches 32°F / 0°C',
    'SWE': 'Snow Water Equivalent — water content of snowpack',
    'PTYPE': 'Precipitation Type (rain, snow, sleet, freezing rain)',
    'graupel': 'Soft hail / snow pellets — forms in convective clouds',
    'virga': 'Precipitation that evaporates before reaching the ground',
    'dry punch': 'A surge of dry air that can suppress precipitation',
    'moisture plume': 'A band of high atmospheric moisture',
    'wrap-around moisture': 'Moisture wrapping around the backside of a low pressure system',

    // Warnings & watches
    'PDS': 'Particularly Dangerous Situation',
    'SVR': 'Severe thunderstorm',
    'TOR': 'Tornado',
    'FFW': 'Flash Flood Warning',
    'HWO': 'Hazardous Weather Outlook',
    'red flag': 'Red Flag Warning — critical fire weather conditions',
    'fire weather watch': 'Conditions may develop for critical fire weather',

    // Misc
    'CWA': 'County Warning Area — the NWS office\'s forecast territory',
    'WFO': 'Weather Forecast Office',
    'NWS': 'National Weather Service',
    'NDFD': 'National Digital Forecast Database',
    'MOS': 'Model Output Statistics',
    'sounding': 'A vertical profile of temperature, moisture, and wind',
    'RAOB': 'Radiosonde observation — weather balloon data',
    'prog': 'Prognostic chart — a forecast map',
    'synoptic': 'Large-scale weather patterns (hundreds to thousands of miles)',
    'mesoscale': 'Medium-scale weather features (tens to hundreds of miles)',
    'microscale': 'Small-scale weather features (under 10 miles)',
    'diurnal': 'Daily cycle — daytime heating, nighttime cooling',
    'nocturnal': 'Occurring at night',
    'fetch': 'Distance over water that wind blows — longer = bigger waves',
    'inland': 'Away from the coast, toward the interior',
    'coastal': 'Near the ocean shoreline',
    'NW flow': 'Northwest flow — air moving from the northwest, often cool and dry',
    'SW flow': 'Southwest flow — air moving from the southwest, often warm and moist',
    'SE flow': 'Southeast flow — air from the southeast, can bring moisture',
    'NE flow': 'Northeast flow — air from the northeast, often associated with offshore/Santa Ana winds',
};

// ─── Office timezone mapping ────────────────────────────────────────
const OFFICE_TIMEZONES = {
    'LOX': 'America/Los_Angeles',
    'SGX': 'America/Los_Angeles',
    'HNX': 'America/Los_Angeles',
    'VEF': 'America/Los_Angeles',
    'MTR': 'America/Los_Angeles',
    'SEW': 'America/Los_Angeles',
    'PQR': 'America/Los_Angeles',
    'OKX': 'America/New_York',
};
let currentOffice = 'LOX';

// ─── Section parsing ───────────────────────────────────────────────
const SECTION_NAMES = {
    'SYNOPSIS': 'Synopsis',
    'DISCUSSION': 'Synopsis',
    'SHORT TERM': 'Short Term',
    'NEAR TERM': 'Short Term',
    'LONG TERM': 'Long Term',
    'EXTENDED': 'Long Term',
    'AVIATION': 'Aviation',
    'MARINE': 'Marine',
    'BEACHES': 'Beaches',
    'FIRE WEATHER': 'Fire Weather',
    'LOX WATCHES/WARNINGS/ADVISORIES': 'Active Alerts',
    'WATCHES/WARNINGS/ADVISORIES': 'Active Alerts',
};

function parseSections(text) {
    // Remove header lines (product header, timestamps at very top)
    const lines = text.split('\n');
    const sections = [];
    let currentKey = null;
    let currentLines = [];
    let forecaster = '';

    for (const line of lines) {
        // Check for section headers: .SYNOPSIS..., .SHORT TERM (TDY-TUE)..., .LOX WATCHES/WARNINGS/ADVISORIES...
        // Try with office prefix first (3-letter like LOX, SGX)
        const headerMatch = line.match(/^\.(?:LOX|SGX|HNX|VEF|MTR|SEW|PQR|OKX)\s+([A-Z\s\/]+?)(?:\s*\([^)]*\))?\s*\.{2,3}/)
            || line.match(/^\.([A-Z\s\/]+?)(?:\s*\([^)]*\))?\s*\.{2,3}/);
        if (headerMatch) {
            if (currentKey) {
                sections.push({ key: currentKey, text: currentLines.join('\n').trim() });
            }
            const rawKey = headerMatch[1].trim();
            // Map to canonical name
            currentKey = SECTION_NAMES[rawKey] || rawKey.charAt(0) + rawKey.slice(1).toLowerCase();
            currentLines = [line.replace(headerMatch[0], '').trim()];
            continue;
        }
        // Check for $$ delimiter (end of section / forecaster signature)
        if (line.trim() === '$$') {
            if (currentKey) {
                sections.push({ key: currentKey, text: currentLines.join('\n').trim() });
                currentKey = null;
                currentLines = [];
            }
            continue;
        }
        // Forecaster line
        if (line.match(/^&&$/)) continue;
        if (currentKey) {
            currentLines.push(line);
        }
        // Try to find forecaster
        const fMatch = line.match(/^\.?(?:Forecaster|FORECASTER)[:\s]+(.+)/i);
        if (fMatch) forecaster = fMatch[1].trim();
    }
    if (currentKey) {
        sections.push({ key: currentKey, text: currentLines.join('\n').trim() });
    }

    // Clean up: remove forecaster lines from section text, remove trailing &&
    for (const s of sections) {
        s.text = s.text.replace(/&&\s*$/, '').replace(/^\s*&&\s*/gm, '').trim();
        // Extract forecaster if embedded at end
        const fm = s.text.match(/\n\s*(?:Forecaster|FORECASTER)[:\s]*(.+)$/im);
        if (fm) {
            if (!forecaster) forecaster = fm[1].trim();
            s.text = s.text.replace(fm[0], '').trim();
        }
    }

    return { sections, forecaster };
}

// ─── Plain English translation ─────────────────────────────────────
function translateToPlainEnglish(text) {
    let t = text;

    // Remove NWS timestamps like "15/913 AM.", "15/935 AM.", "15/1801Z.", "15/1002 AM."
    t = t.replace(/\d{2}\/\d{3,4}\s*(?:AM|PM|Z)\.?\s*/gi, '');

    // Remove NWS product code references and "see the CFWLOX..." sentences
    t = t.replace(/,?\s*see\s+the\s+[A-Z]{3,12}\s+(?:and\s+[A-Z]{3,12}\s+)?products?\s+for\s+more\s+details\.?/gi, '.');
    t = t.replace(/\b(?:See\s+)?(?:Lax|Cfw|Srf|Npw|Mww|Wsw|Ffa)[a-z]{2,8}\b\.?/gi, '');

    // Remove zone number lists (e.g., "for zones 38-344-345-353...")
    t = t.replace(/for\s+zones?\s+[\d\->]+/gi, '');

    // Remove raw NWS product references in parens, and empty parens
    t = t.replace(/\(See\s+[A-Za-z]+\)/gi, '');
    t = t.replace(/\(\s*\)/g, '');

    // Convert ***Header*** to sub-section markers (before collapsing whitespace)
    t = t.replace(/\*{3}\s*([^*]+?)\s*\*{3}/g, '\n\n§§§$1§§§\n\n');

    // Remove embedded sub-section headers like ".SHORT TERM (TDY-TUE)..." that leak through
    t = t.replace(/\.(?:SHORT|LONG|NEAR)\s+TERM\s*\([^)]*\)\.\s*/gi, '');

    // Remove NWS formatting artifacts
    t = t.replace(/\.{3,}/g, '. ');
    // Collapse runs of spaces (but preserve newlines for paragraph splitting)
    t = t.replace(/[ \t]{2,}/g, ' ');

    // Expand abbreviations
    const abbrevs = [
        // General weather abbreviations
        [/\bchc\b/gi, 'chance'],
        [/\bcsts\b/gi, 'coasts'],
        [/\bvlys\b/gi, 'valleys'],
        [/\bmtns\b/gi, 'mountains'],
        [/\bwnds\b/gi, 'winds'],
        [/\btemps\b/gi, 'temperatures'],
        [/\bpcpn\b/gi, 'precipitation'],
        [/\bprecip\b/gi, 'precipitation'],
        [/\baftn\b/gi, 'afternoon'],
        [/\bmrng\b/gi, 'morning'],
        [/\berly\b/gi, 'early'],
        [/\bthru\b/gi, 'through'],
        [/\bbtwn\b/gi, 'between'],
        [/\bisol\b/gi, 'isolated'],
        [/\bnum\b/gi, 'numerous'],
        [/\bocnl\b/gi, 'occasional'],
        [/\bintmt\b/gi, 'intermittent'],
        [/\bcont\b/gi, 'continue'],
        [/\bincr\b/gi, 'increase'],
        [/\bdecr\b/gi, 'decrease'],
        [/\bdevel\b/gi, 'develop'],
        [/\bdvlpg\b/gi, 'developing'],
        [/\bwrn\b/gi, 'western'],
        [/\bsrn\b/gi, 'southern'],
        [/\bnrn\b/gi, 'northern'],
        [/\bcntrl\b/gi, 'central'],
        [/\bfcst\b/gi, 'forecast'],
        [/\bblo\b/gi, 'below'],
        [/\babv\b/gi, 'above'],
        [/\bxtrm\b/gi, 'extreme'],
        [/\bposs\b/gi, 'possible'],
        [/\bprob\b/gi, 'probable'],

        // County/region abbreviations (California-specific)
        [/\bSLO\b/g, 'San Luis Obispo'],
        [/\bSBA\b/g, 'Santa Barbara'],
        [/\bVTA\b/g, 'Ventura'],
        [/\bLA\b/g, 'Los Angeles'],

        // Storm & dynamics
        [/\bTSTMS?\b/gi, 'thunderstorms'],
        [/\bSFC\b/g, 'surface'],
        [/\bsfc\b/g, 'surface'],
        [/\btrof\b/gi, 'trough'],
        [/\bPWATs?\b/g, 'precipitable water'],
        [/\bQPF\b/g, 'expected rainfall'],
        [/\bPoPs?\b/gi, 'chance of rain'],
        [/\bCAPE\b/g, 'storm energy'],
        [/\bCIN\b/g, 'convective cap'],
        [/\bRH\b/g, 'humidity'],
        [/\bSLP\b/g, 'sea level pressure'],

        // Models → friendly names
        [/\bNBM\b/g, 'the blend-of-models forecast'],
        [/\bHRRR\b/g, 'the high-res rapid-refresh model'],
        [/\bGFS\b/g, 'the American global model'],
        [/\bECMWF\b/g, 'the European model'],
        [/\bNAM\b/g, 'the regional model'],
        [/\bhi\s+res\b/gi, 'high-resolution'],
        [/\bclimo\b/gi, 'the historical average'],
        [/\bdiurnal\b/gi, 'daily'],
        [/\bnocturnal\b/gi, 'nighttime'],

        // Aviation
        [/\bMVFR\b/g, 'marginal visual flying conditions'],
        [/\bLIFR\b/g, 'very low visibility flying conditions'],
        [/\bIFR\b/g, 'instrument-only flying conditions'],
        [/\bVFR\b/g, 'good visual flying conditions'],
        [/\bTAFs?\b/g, 'airport forecasts'],
        [/\bGDP\b/g, 'ground delay program'],
        [/\bCIGS?\b/gi, 'ceilings'],
        [/\bVSBY\b/gi, 'visibility'],
        [/\bCLR\b/g, 'clear skies'],
        [/\bAGL\b/g, 'above ground'],
        [/\bMSL\b/g, 'above sea level'],
        [/\bFL\b/g, 'flight level'],

        // Sky conditions with optional height numbers: BKN015 → broken clouds at 1,500 ft
        [/\bBKN(\d{3})\b/g, (_, h) => `broken clouds at ${parseInt(h)*100} ft`],
        [/\bOVC(\d{3})\b/g, (_, h) => `overcast at ${parseInt(h)*100} ft`],
        [/\bSCT(\d{3})\b/g, (_, h) => `scattered clouds at ${parseInt(h)*100} ft`],
        [/\bFEW(\d{3})\b/g, (_, h) => `few clouds at ${parseInt(h)*100} ft`],
        [/\bBKN\b/g, 'broken clouds'],
        [/\bOVC\b/g, 'overcast'],
        [/\bSCT\b/g, 'scattered clouds'],
        [/\bFEW\b/g, 'few clouds'],

        // Marine
        [/\bSCA\b/g, 'small craft advisory'],
        [/\bGALE\b/g, 'gale warning'],
        [/\bKTS\b/gi, 'knots'],
        [/\bkt\b/gi, 'knot'],
        [/\bNM\b/g, 'nautical miles'],

        // Airport codes to names
        [/\bKLAX\b/g, 'LAX'],
        [/\bKBUR\b/g, 'Burbank'],
        [/\bKSNA\b/g, 'Orange County'],
        [/\bKVNY\b/g, 'Van Nuys'],
        [/\bKSMO\b/g, 'Santa Monica'],
        [/\bKONT\b/g, 'Ontario'],
        [/\bKSBA\b/g, 'Santa Barbara'],
        [/\bKOXR\b/g, 'Oxnard'],
        [/\bKLGB\b/g, 'Long Beach'],
        [/\bKSAN\b/g, 'San Diego'],
        [/\bKPMD\b/g, 'Palmdale'],
        [/\bKWJF\b/g, 'Lancaster'],

        // Phenomena
        [/\bAR\b/g, 'atmospheric river'],
        [/\bIVT\b/g, 'moisture transport'],
        [/\bPDS\b/g, 'particularly dangerous'],
        [/\bSWE\b/g, 'snow water content'],

        // Previously leaked abbreviations
        [/\bLI\b/g, 'lifted index'],
        [/\bOFB\b/g, 'outflow boundary'],
        [/\bFROPA\b/g, 'frontal passage'],
        [/\bGS\b/g, 'ground stop'],
        [/\bUTC\b/g, 'UTC'],
        [/\bWFO\b/g, 'Weather Forecast Office'],
        [/\bCWA\b/g, 'forecast area'],
        [/\bRAOB\b/g, 'weather balloon data'],
        [/\bMOS\b/g, 'model output statistics'],
        [/\bNW\s+flow\b/gi, 'northwest flow'],
        [/\bSW\s+flow\b/gi, 'southwest flow'],
        [/\bSE\s+flow\b/gi, 'southeast flow'],
        [/\bNE\s+flow\b/gi, 'northeast flow'],
    ];

    for (const [pat, rep] of abbrevs) {
        t = t.replace(pat, rep);
    }

    // Convert Zulu time references: 18Z → local time (DST-aware)
    t = t.replace(/\b(\d{2,4})Z\b/g, (_, h) => {
        const utcHour = parseInt(h.length <= 2 ? h : h.substring(0, 2));
        const utcMin = h.length > 2 ? parseInt(h.substring(2)) : 0;
        // Create a UTC date for today to get proper DST offset
        const now = new Date();
        const utcDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), utcHour, utcMin));
        // Use the office timezone if available, fallback to America/Los_Angeles
        const tz = OFFICE_TIMEZONES[currentOffice] || 'America/Los_Angeles';
        try {
            const local = utcDate.toLocaleString('en-US', { hour: 'numeric', minute: utcMin > 0 ? '2-digit' : undefined, timeZone: tz, timeZoneName: 'short' });
            return local;
        } catch {
            // Fallback to simple offset
            const offset = tz.includes('Eastern') ? -5 : tz.includes('Central') ? -6 : tz.includes('Mountain') ? -7 : -8;
            let localHr = (utcHour + offset + 24) % 24;
            const ampm = localHr >= 12 ? 'PM' : 'AM';
            const hr12 = localHr === 0 ? 12 : localHr > 12 ? localHr - 12 : localHr;
            return `${hr12} ${ampm}`;
        }
    });

    // Clean up geopotential heights: "541 dam" → "a 541-dam"
    t = t.replace(/(\d{3})\s*dam\b/g, '$1-decameter');

    // Clean up pressure level references
    t = t.replace(/(\d{3,4})\s*mb\b/g, '$1 mb level');

    // Convert long ALL CAPS stretches (5+ chars) to sentence case (skip known terms)
    t = t.replace(/\b([A-Z]{5,})\b/g, (m) => {
        if (GLOSSARY[m]) return m;
        return m.charAt(0) + m.slice(1).toLowerCase();
    });

    // Remove "ern" that got left as standalone (from "eastern" abbrev collision with words ending in "ern")
    // Actually, let's be more careful — only expand \bern\b when it's standalone
    t = t.replace(/\bern\b/gi, 'eastern');

    // Clean up artifacts from stripped content
    t = t.replace(/\.\s*\.\s*/g, '. ');       // ". ." → "."
    t = t.replace(/\s{2,}/g, ' ');
    t = t.replace(/^\.\s*/gm, '');
    t = t.replace(/\bCA\.\s*/g, '');            // Strip state prefix "CA."
    t = t.replace(/\bPZ\.\s*/g, '');            // Strip marine zone prefix "PZ."
    t = t.trim();

    // ─── Bold pass: make key info skimmable ─────────────────────────
    // Days of week and timeframes
    t = t.replace(/\b(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b/g, '<strong>$1</strong>');
    t = t.replace(/\b(tonight|tonight through \w+|this morning|this afternoon|this evening|overnight)\b/gi, '<strong>$1</strong>');
    t = t.replace(/\b(today)\b/gi, '<strong>$1</strong>');

    // Temperatures and measurements
    t = t.replace(/(\d{1,3})\s*(?:degrees?|°)\s*(?:F|fahrenheit)?/gi, '<strong>$1°</strong>');
    t = t.replace(/\b(\d{1,3})\s*(?:mph|knots?)\b/gi, '<strong>$1 mph</strong>');

    // Ranges with "to" or hyphens + units: "4 to 8 inches", "1-2.5 inches", "10 to 15 ft"
    t = t.replace(/\b(\d+(?:\.\d+)?)\s*(?:to|-)\s*(\d+(?:\.\d+)?)\s*(inches?|"|feet|ft)\b/gi,
        (_, a, b, unit) => { const u = unit.startsWith('f') ? ' ft' : '"'; return `<strong>${a}–${b}${u}</strong>`; });
    // Single number + units: "8 inches", "15 ft"
    t = t.replace(/\b(\d+(?:\.\d+)?)\s*(inches?|")\b/gi, '<strong>$1"</strong>');
    t = t.replace(/\b(\d+(?:\.\d+)?)\s*(feet|ft)\b/gi, '<strong>$1 ft</strong>');

    // Worded ranges: "a half and one inch per hour", "half inch"
    t = t.replace(/\b((?:a\s+)?half(?:\s+and\s+one)?\s+inch(?:\s+per\s+hour)?)\b/gi, '<strong>$1</strong>');

    // Hazard/warning language
    t = t.replace(/\b(severe thunderstorms?|flash flood(?:ing)?|debris flows?|damaging winds?|heavy (?:mountain )?snow|high surf|coastal flood(?:ing)?|thunderstorms?)\b/gi, '<strong>$1</strong>');
    t = t.replace(/\b(small craft advisory|gale warning|winter storm (?:watch|warning)|flood watch|wind advisory|high wind watch|high surf advisory|beach hazards? statement)\b/gi, '<strong>$1</strong>');

    // Clean up any double-bolded from overlapping matches
    t = t.replace(/<strong><strong>/g, '<strong>');
    t = t.replace(/<\/strong><\/strong>/g, '</strong>');

    // Split into blocks on double newlines
    const blocks = t.split(/\n\s*\n+/).filter(b => b.trim());

    let html = '';
    for (const block of blocks) {
        const trimmed = block.trim();
        // Check for sub-section header marker
        const subMatch = trimmed.match(/§§§\s*(.+?)\s*§§§\s*([\s\S]*)/);
        if (subMatch) {
            const title = subMatch[1].trim();
            const body = subMatch[2].trim();
            html += `<h4 class="sub-header">${title}</h4>`;
            if (body) html += `<p>${body}</p>`;
        } else if (!trimmed.match(/^§§§/)) {
            // Skip orphaned markers, render normal paragraphs
            html += `<p>${trimmed.replace(/\n/g, ' ')}</p>`;
        }
    }
    return html;
}

// ─── Annotated text with jargon highlights ──────────────────────────
function annotateText(text) {
    // Escape HTML
    let t = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

    // Sort glossary keys by length desc so longer matches first
    const keys = Object.keys(GLOSSARY).sort((a, b) => b.length - a.length);

    // Use placeholder tokens to prevent nested replacement
    const placeholders = [];
    for (const key of keys) {
        const escaped = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`\\b${escaped}\\b`, 'g');
        t = t.replace(regex, (match) => {
            const idx = placeholders.length;
            const tipText = GLOSSARY[key].replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            placeholders.push(`<span class="jargon">${match}<span class="tip">${tipText}</span></span>`);
            return `\x00JARGON${idx}\x00`;
        });
    }

    // Replace placeholders with actual HTML
    for (let i = 0; i < placeholders.length; i++) {
        t = t.replace(`\x00JARGON${i}\x00`, placeholders[i]);
    }

    return t;
}

// ─── Key Takeaway extraction ────────────────────────────────────────
function extractTakeaway(sections) {
    // Use synopsis, or first section
    const synSection = sections.find(s => s.key === 'Synopsis') || sections[0];
    if (!synSection) return '';
    // Take first 1-2 sentences
    const text = synSection.text.replace(/\.{2,}/g, '. ').replace(/\s+/g, ' ').trim();
    const sentences = text.match(/[^.!?]+[.!?]+/g);
    if (!sentences) return text.substring(0, 200);
    const takeaway = sentences.slice(0, 2).join(' ').trim();
    // Quick cleanup
    return translateToPlainEnglish(takeaway).replace(/<\/?p>/g, '');
}

// ─── Confidence indicator ────────────────────────────────────────────
function displayConfidence(fullText) {
    const container = document.getElementById('confidence-container');
    const bar = document.getElementById('confidence-bar');
    const text = document.getElementById('confidence-text');
    const t = fullText.toLowerCase();

    // Count uncertainty vs certainty language
    const uncertainWords = [
        'uncertain', 'uncertainty', 'low confidence', 'unclear', 'remain uncertain',
        'possible', 'possibly', 'could', 'might', 'may', 'perhaps',
        'slight chance', 'can\'t rule out', 'cannot rule out',
        'tricky', 'challenging', 'difficult', 'complicated',
        'spread', 'wide range', 'diverge', 'disagreement', 'inconsistent',
        'low predictability', 'questionable', 'iffy', 'depends on',
    ];
    const certainWords = [
        'high confidence', 'confident', 'certain', 'expected',
        'will', 'likely', 'probable', 'increasing confidence',
        'good agreement', 'consistent', 'consensus',
        'strong signal', 'well-defined', 'increasingly likely',
        'on track', 'remains on track',
    ];

    let uncertainCount = 0;
    let certainCount = 0;
    for (const w of uncertainWords) { const m = t.match(new RegExp(w, 'gi')); if (m) uncertainCount += m.length; }
    for (const w of certainWords) { const m = t.match(new RegExp(w, 'gi')); if (m) certainCount += m.length; }

    const total = uncertainCount + certainCount;
    if (total === 0) { container.style.display = 'none'; return; }

    // Score: 0 (all uncertain) to 100 (all certain)
    const score = Math.round((certainCount / total) * 100);

    // Map to label and color
    let label, color;
    if (score >= 75) { label = 'High'; color = '#16a34a'; }
    else if (score >= 50) { label = 'Moderate'; color = '#2563eb'; }
    else if (score >= 30) { label = 'Mixed'; color = '#d97706'; }
    else { label = 'Low'; color = '#dc2626'; }

    bar.style.width = `${score}%`;
    bar.style.background = color;
    text.textContent = label;
    text.style.color = color;
    container.style.display = '';
}

// ─── Format Active Alerts as a clean list ───────────────────────────
function formatAlerts(text) {
    // Split on alert types and format as list items
    let t = text;
    // Strip zone codes, product codes, state/marine prefixes
    t = t.replace(/for\s+zones?\s+[\d\->]+/gi, '');
    t = t.replace(/\(See\s+[A-Za-z]+\)/gi, '');
    t = t.replace(/\(\s*\)/g, '');
    t = t.replace(/\bCA\s*\.{1,3}\s*/g, '');
    t = t.replace(/\bPZ\s*\.{1,3}\s*/g, '');
    t = t.replace(/\b(?:Lax|Cfw|Srf|Npw|Mww|Wsw|Ffa)[a-z]{2,8}\b\.?/gi, '');
    t = t.replace(/\.\s*\.\s*/g, '. ');
    t = t.replace(/\s{2,}/g, ' ').trim();

    // Split on known alert types to create individual items
    const alertPattern = /((?:High Wind Watch|Wind Advisory|Flood Watch|High Surf Advisory|Beach Hazards? Statement|Winter Storm (?:Watch|Warning)|Small Craft Advisory|Gale Warning|Storm Warning|Red Flag Warning|Fire Weather Watch|Tornado Watch|Tornado Warning|Severe Thunderstorm (?:Watch|Warning)|Flash Flood Warning|Blizzard Warning|Ice Storm Warning|Freeze Warning|Frost Advisory|Dense Fog Advisory|Heat Advisory|Excessive Heat Warning)[^.]*\.?)/gi;

    const matches = t.match(alertPattern);
    if (!matches || matches.length === 0) {
        return `<p>${t}</p>`;
    }

    const items = matches.map(m => {
        let item = m.trim().replace(/\.\s*$/, '').replace(/^\.\s*/, '').trim();
        // Capitalize first letter
        item = item.charAt(0).toUpperCase() + item.slice(1);
        return `<li>${item}</li>`;
    });

    return `<ul class="alert-list">${items.join('')}</ul>`;
}

// ─── Render ─────────────────────────────────────────────────────────
function render(sections) {
    const sectionsEl = document.getElementById('sections');
    const navEl = document.getElementById('section-nav');
    const takeawayContainer = document.getElementById('takeaway-container');
    const takeawayText = document.getElementById('takeaway-text');

    // Key takeaway
    const takeaway = extractTakeaway(sections);
    if (takeaway) {
        takeawayText.innerHTML = takeaway;
        takeawayContainer.style.display = '';
    }

    // Section nav — sanitize IDs for URL safety
    const safeId = (key) => key.replace(/[^a-zA-Z0-9]+/g, '-').replace(/^-|-$/g, '').toLowerCase();
    navEl.innerHTML = sections.map(s =>
        `<a href="#section-${safeId(s.key)}">${s.key}</a>`
    ).join('');

    // Sections
    sectionsEl.innerHTML = sections.map(s => {
        let plainHtml;
        if (s.key === 'Active Alerts') {
            // Format alerts as a clean bullet list
            plainHtml = formatAlerts(s.text);
        } else {
            plainHtml = translateToPlainEnglish(s.text);
        }
        return `
        <div class="forecast-section" id="section-${safeId(s.key)}">
            <div class="section-title">${s.key}</div>
            <div class="columns">
                <div>
                    <div class="col-label">Plain English</div>
                    <div class="plain-col">${plainHtml}</div>
                </div>
                <div>
                    <div class="col-label">Original + Annotations</div>
                    <div class="annotated-col">${annotateText(s.text)}</div>
                </div>
            </div>
        </div>`;
    }).join('');
}

// ─── Fetch AFD ──────────────────────────────────────────────────────
async function fetchAFD(office) {
    currentOffice = office;
    const sectionsEl = document.getElementById('sections');
    sectionsEl.innerHTML = '<div class="loading">Loading forecast…</div>';

    // Update footer office name
    const footerOffice = document.getElementById('footer-office');
    if (footerOffice) footerOffice.textContent = office;

    // Check cache first (15 min TTL)
    const cached = sessionStorage.getItem(`afd-${office}`);
    if (cached) {
        try {
            const { time, prodData } = JSON.parse(cached);
            if (Date.now() - time < 15 * 60 * 1000) {
                renderAFD(prodData, office);
                return;
            }
        } catch { /* stale cache, continue to fetch */ }
    }

    try {
        const listRes = await fetch(`https://api.weather.gov/products/types/AFD/locations/${office}`, {
            headers: { 'User-Agent': 'Plaincast/1.0 (plaincast.live)' }
        });
        if (!listRes.ok) throw new Error(`API error: ${listRes.status} ${listRes.statusText}`);
        const listData = await listRes.json();
        const latest = listData['@graph']?.[0];
        if (!latest) throw new Error('No AFD found for this office');

        const prodUrl = latest['@id'] || `https://api.weather.gov/products/${latest.id}`;
        const prodRes = await fetch(prodUrl, {
            headers: { 'User-Agent': 'Plaincast/1.0 (plaincast.live)' }
        });
        if (!prodRes.ok) throw new Error(`Product fetch error: ${prodRes.status}`);
        const prodData = await prodRes.json();

        // Cache the result
        sessionStorage.setItem(`afd-${office}`, JSON.stringify({
            time: Date.now(),
            prodData
        }));

        renderAFD(prodData, office);

    } catch (err) {
        // Try stale cache as fallback
        if (cached) {
            try {
                const { prodData } = JSON.parse(cached);
                renderAFD(prodData, office);
                return;
            } catch { /* give up */ }
        }
        sectionsEl.innerHTML = `<div class="loading">Error loading forecast: ${err.message}</div>`;
        console.error(err);
    }
}

function renderAFD(prodData, office) {
    const sectionsEl = document.getElementById('sections');

    // Update raw link
    const rawUrl = prodData['@id'] || `https://api.weather.gov/products/${prodData.id}`;
    document.getElementById('raw-link').href = rawUrl;

    // Parse issue time with office timezone
    const tz = OFFICE_TIMEZONES[office] || 'America/Los_Angeles';
    const issueTime = new Date(prodData.issuanceTime);
    const now = new Date();
    const diffMs = now - issueTime;
    const diffHours = Math.round(diffMs / 3600000);
    const diffMins = Math.round(diffMs / 60000);
    let ago = '';
    if (diffMins < 60) ago = `${diffMins} minutes ago`;
    else if (diffHours < 24) ago = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    else ago = `${Math.round(diffHours / 24)} day${Math.round(diffHours/24) !== 1 ? 's' : ''} ago`;

    document.getElementById('issue-time').textContent =
        `Issued ${issueTime.toLocaleString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', timeZone: tz, timeZoneName: 'short' })} — ${ago}`;

    // Parse sections
    const { sections } = parseSections(prodData.productText);
    if (sections.length === 0) {
        sectionsEl.innerHTML = '<div class="loading">Could not parse forecast sections.</div>';
        return;
    }

    // Extract and display confidence
    displayConfidence(prodData.productText);

    render(sections);
}

// ─── Init ───────────────────────────────────────────────────────────
const officeSelect = document.getElementById('office-select');
officeSelect.addEventListener('change', () => fetchAFD(officeSelect.value));
fetchAFD(officeSelect.value);
</script>

</body>
</html>
